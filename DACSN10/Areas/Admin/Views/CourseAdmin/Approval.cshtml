@model List<DACSN10.Areas.Admin.Models.CourseApprovalViewModel>
@{
    ViewData["Title"] = "Phê duyệt khóa học";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid px-4 animate__animated animate__fadeIn">
    <h1 class="mt-4">Phê duyệt khóa học</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/Admin">Trang chủ</a></li>
        <li class="breadcrumb-item"><a asp-action="Index">Khóa học</a></li>
        <li class="breadcrumb-item active">Phê duyệt</li>
    </ol>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-clipboard-check me-1"></i>
            Danh sách khóa học chờ duyệt
        </div>
        <div class="card-body">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table id="pendingTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên khóa học</th>
                                <th>Giảng viên</th>
                                <th>Giá</th>
                                <th>Ngày tạo</th>
                                <th>Danh mục</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.CourseID</td>
                                    <td>
                                        <a href="#" class="text-decoration-none course-title" data-id="@item.CourseID" data-bs-toggle="modal" data-bs-target="#courseDetailModal">
                                            @item.TenKhoaHoc
                                        </a>
                                    </td>
                                    <td>@item.TenGiangVien</td>
                                    <td>@item.Gia.ToString("N0") VNĐ</td>
                                    <td>@item.NgayTao.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        @foreach (var category in item.DanhMucList)
                                        {
                                            <span class="badge bg-info me-1">@category</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-success btn-sm approve-btn" data-id="@item.CourseID" data-bs-toggle="tooltip" title="Phê duyệt">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm reject-btn" data-id="@item.CourseID" data-bs-toggle="tooltip" title="Từ chối">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <a asp-action="Details" asp-route-id="@item.CourseID" class="btn btn-info btn-sm text-white" data-bs-toggle="tooltip" title="Chi tiết">
                                                <i class="fas fa-info-circle"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Modal Preview Chi tiết khóa học -->
                <div class="modal fade" id="courseDetailModal" tabindex="-1" aria-labelledby="courseDetailModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="courseDetailModalLabel">Chi tiết khóa học</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="coursePreview">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Đang tải...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                <button type="button" class="btn btn-success" id="approveInModal">Phê duyệt</button>
                                <button type="button" class="btn btn-danger" id="rejectInModal">Từ chối</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Nhập lý do từ chối -->
                <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="rejectModalLabel">Từ chối khóa học</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="rejectForm" method="post">
                                    <input type="hidden" id="rejectCourseId" name="id" />
                                    <div class="mb-3">
                                        <label for="rejectReason" class="form-label">Lý do từ chối</label>
                                        <textarea class="form-control" id="rejectReason" name="lyDo" rows="4" required></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                                <button type="button" class="btn btn-danger" id="confirmReject">Xác nhận từ chối</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> Không có khóa học nào đang chờ duyệt.
                </div>
            }

            <div class="mt-3">
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Trở về danh sách
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // DataTables
            $('#pendingTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json'
                },
                responsive: true,
                order: [[4, 'desc']]
            });

            // Tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Hiển thị thông báo thành công nếu có
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
                    toastr.success('@TempData["SuccessMessage"]', 'Thành công');
            </text>
        }

            // Hiển thị thông báo lỗi nếu có
        @if (TempData["ErrorMessage"] != null)
        {
            <text>
                    toastr.error('@TempData["ErrorMessage"]', 'Lỗi');
            </text>
        }

            // Xử lý sự kiện nút phê duyệt
            $('.approve-btn').click(function () {
                const courseId = $(this).data('id');

                Swal.fire({
                    title: 'Xác nhận phê duyệt',
                    text: "Bạn có chắc chắn muốn phê duyệt khóa học này?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Đồng ý',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Gửi form phê duyệt
                        const form = $('<form>', {
                            'method': 'post',
                            'action': '@Url.Action("ApproveCourse")'
                        }).append($('<input>', {
                            'name': 'id',
                            'value': courseId,
                            'type': 'hidden'
                        })).append($('<input>', {
                            'name': '__RequestVerificationToken',
                            'value': $('input[name="__RequestVerificationToken"]').val(),
                            'type': 'hidden'
                        }));

                        $('body').append(form);
                        form.submit();
                    }
                });
            });

            // Xử lý sự kiện nút từ chối
            $('.reject-btn').click(function () {
                const courseId = $(this).data('id');
                $('#rejectCourseId').val(courseId);
                $('#rejectModal').modal('show');
            });

            // Xác nhận từ chối
            $('#confirmReject').click(function () {
                if (!$('#rejectReason').val().trim()) {
                    toastr.error('Vui lòng nhập lý do từ chối', 'Lỗi');
                    return;
                }

                // Gửi form từ chối
                const form = $('<form>', {
                    'method': 'post',
                    'action': '@Url.Action("RejectCourse")'
                }).append($('<input>', {
                    'name': 'id',
                    'value': $('#rejectCourseId').val(),
                    'type': 'hidden'
                })).append($('<input>', {
                    'name': 'lyDo',
                    'value': $('#rejectReason').val(),
                    'type': 'hidden'
                })).append($('<input>', {
                    'name': '__RequestVerificationToken',
                    'value': $('input[name="__RequestVerificationToken"]').val(),
                    'type': 'hidden'
                }));

                $('body').append(form);
                form.submit();
            });

            // Xử lý sự kiện xem chi tiết khóa học trong modal
            $('.course-title').click(function () {
                const courseId = $(this).data('id');
                $('#coursePreview').html('<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Đang tải...</span></div></div>');

                // Lưu ID khóa học vào modal để sử dụng cho nút phê duyệt/từ chối
                $('#approveInModal').data('id', courseId);
                $('#rejectInModal').data('id', courseId);

                // Ajax load nội dung khóa học
                $.ajax({
                    url: '/Admin/CourseAdmin/Details/' + courseId + '?partial=true',
                    type: 'GET',
                    success: function (data) {
                        $('#coursePreview').html(data);
                    },
                    error: function () {
                        $('#coursePreview').html('<div class="alert alert-danger">Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.</div>');
                    }
                });
            });

            // Xử lý phê duyệt từ modal
            $('#approveInModal').click(function () {
                const courseId = $(this).data('id');
                $('.approve-btn[data-id="' + courseId + '"]').click();
                $('#courseDetailModal').modal('hide');
            });

            // Xử lý từ chối từ modal
            $('#rejectInModal').click(function () {
                const courseId = $(this).data('id');
                $('#rejectCourseId').val(courseId);
                $('#courseDetailModal').modal('hide');
                $('#rejectModal').modal('show');
            });

            // Hiệu ứng Animate.css
            $(".card").addClass("animate__animated animate__fadeIn");

            // Hướng dẫn với Intro.js
            function startTutorial() {
                introJs().setOptions({
                    steps: [
                        {
                            element: document.querySelector('.card-header'),
                            intro: 'Đây là trang phê duyệt khóa học đang chờ.'
                        },
                        {
                            element: document.querySelector('#pendingTable'),
                            intro: 'Danh sách các khóa học đang chờ phê duyệt.'
                        },
                        {
                            element: document.querySelector('.approve-btn'),
                            intro: 'Nhấn nút này để phê duyệt khóa học.'
                        },
                        {
                            element: document.querySelector('.reject-btn'),
                            intro: 'Nhấn nút này để từ chối khóa học.'
                        }
                    ],
                    prevLabel: 'Trước',
                    nextLabel: 'Tiếp',
                    skipLabel: 'Bỏ qua',
                    doneLabel: 'Xong'
                }).start();
            }

            // Thêm nút hướng dẫn
            $('<button type="button" class="btn btn-sm btn-outline-info float-end ms-2" onclick="startTutorial()"><i class="fas fa-question-circle"></i> Hướng dẫn</button>')
                .appendTo('.card-header');
        });
    </script>
}