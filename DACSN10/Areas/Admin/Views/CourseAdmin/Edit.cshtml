@model DACSN10.Areas.Admin.Models.CourseAdminViewModel
@{
    ViewData["Title"] = "Chỉnh sửa khóa học";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid px-4 animate__animated animate__fadeIn">
    <h1 class="mt-4">Chỉnh sửa khóa học</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/Admin">Trang chủ</a></li>
        <li class="breadcrumb-item"><a asp-action="Index">Khóa học</a></li>
        <li class="breadcrumb-item active">Chỉnh sửa</li>
    </ol>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-edit me-1"></i>
            Chỉnh sửa thông tin khóa học #@Model.CourseID
        </div>
        <div class="card-body">
            <form asp-action="Edit" method="post" id="editForm">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input type="hidden" asp-for="CourseID" />

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="courseFormTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="basic-tab" data-bs-toggle="tab" href="#basic" role="tab" aria-controls="basic" aria-selected="true">
                            <i class="fas fa-info-circle me-1"></i> Thông tin cơ bản
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="details-tab" data-bs-toggle="tab" href="#details" role="tab" aria-controls="details" aria-selected="false">
                            <i class="fas fa-list-alt me-1"></i> Chi tiết
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="categories-tab" data-bs-toggle="tab" href="#categories" role="tab" aria-controls="categories" aria-selected="false">
                            <i class="fas fa-tag me-1"></i> Danh mục
                        </a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="courseFormTabContent">
                    <!-- Thông tin cơ bản -->
                    <div class="tab-pane fade show active p-3" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="form-outline mb-4">
                                    <label asp-for="TenKhoaHoc" class="form-label">Tên khóa học <span class="text-danger">*</span></label>
                                    <input asp-for="TenKhoaHoc" class="form-control" required />
                                    <span asp-validation-for="TenKhoaHoc" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-outline mb-4">
                                    <label asp-for="Gia" class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                                    <input asp-for="Gia" class="form-control" type="number" min="0" step="10000" required />
                                    <span asp-validation-for="Gia" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-outline mb-4">
                            <label asp-for="MoTa" class="form-label">Mô tả</label>
                            <textarea asp-for="MoTa" class="form-control" id="courseDescription" rows="6"></textarea>
                            <span asp-validation-for="MoTa" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-outline mb-4">
                                    <label class="form-label">Giảng viên <span class="text-danger">*</span></label>
                                    <select asp-for="UserID" class="form-select" required>
                                        <option value="">-- Chọn giảng viên --</option>
                                        @foreach (var teacher in ViewBag.Teachers)
                                        {
                                            <option value="@teacher.Id">@teacher.HoTen</option>
                                        }
                                    </select>
                                    <span asp-validation-for="UserID" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-outline mb-4">
                                    <label asp-for="TrangThai" class="form-label">Trạng thái <span class="text-danger">*</span></label>
                                    <select asp-for="TrangThai" class="form-select" required>
                                        <option value="Chờ duyệt">Chờ duyệt</option>
                                        <option value="Đang hoạt động">Đang hoạt động</option>
                                        <option value="Tạm ngưng">Tạm ngưng</option>
                                        <option value="Bị từ chối">Bị từ chối</option>
                                    </select>
                                    <span asp-validation-for="TrangThai" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chi tiết -->
                    <div class="tab-pane fade p-3" id="details" role="tabpanel" aria-labelledby="details-tab">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-outline mb-4">
                                    <label class="form-label">Ngày tạo</label>
                                    <input asp-for="NgayTao" class="form-control" type="date" readonly />
                                    <span asp-validation-for="NgayTao" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-outline mb-4">
                                    <label class="form-label">Giới hạn học viên (nếu có)</label>
                                    <input class="form-control" type="number" min="0" name="MaxStudents" />
                                </div>
                            </div>
                        </div>

                        <div class="form-outline mb-4">
                            <label class="form-label">Yêu cầu kỹ năng</label>
                            <textarea class="form-control" name="Requirements" rows="4" placeholder="Nhập các yêu cầu hoặc kỹ năng cần có để tham gia khóa học..."></textarea>
                        </div>

                        <div class="form-outline mb-4">
                            <label class="form-label">Kết quả đạt được</label>
                            <textarea class="form-control" name="Outcomes" rows="4" placeholder="Mô tả những gì học viên sẽ đạt được sau khi hoàn thành khóa học..."></textarea>
                        </div>
                    </div>

                    <!-- Danh mục -->
                    <div class="tab-pane fade p-3" id="categories" role="tabpanel" aria-labelledby="categories-tab">
                        <div class="mb-4">
                            <label class="form-label">Chọn danh mục cho khóa học <span class="text-danger">*</span></label>

                            <div class="categories-container">
                                @if (Model.AvailableCategories != null)
                                {
                                    foreach (var category in Model.AvailableCategories)
                                    {
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" name="SelectedCategories" value="@category.CategoryID"
                                                   id="category_@category.CategoryID"
                                            @(Model.SelectedCategories != null && Model.SelectedCategories.Contains(category.CategoryID) ? "checked" : "") />
                                            <label class="form-check-label" for="category_@category.CategoryID">
                                                @category.Name
                                            </label>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i> Không có danh mục nào. Vui lòng thêm danh mục trước.
                                    </div>
                                }
                            </div>
                            <div class="text-danger" id="categoriesError"></div>
                        </div>
                    </div>
                </div>

                <hr />

                <div class="d-flex justify-content-between mt-4">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Trở về danh sách
                    </a>
                    <div>
                        <a asp-action="Details" asp-route-id="@Model.CourseID" class="btn btn-info text-white me-2">
                            <i class="fas fa-info-circle me-1"></i> Xem chi tiết
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Cập nhật
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Syncfusion Rich Text Editor cho mô tả
            $("#courseDescription").ejRichTextEditor({
                width: "100%",
                minWidth: "150px",
                height: "300px",
                showToolbar: true,
                showContextMenu: true,
                tools: {
                    formatStyle: ["format"],
                    edit: ["findAndReplace"],
                    font: ["fontName", "fontSize", "fontColor", "backgroundColor"],
                    style: ["bold", "italic", "underline", "strikethrough"],
                    alignment: ["justifyLeft", "justifyCenter", "justifyRight", "justifyFull"],
                    lists: ["unorderedList", "orderedList"],
                    clipboard: ["cut", "copy", "paste"],
                    doAction: ["undo", "redo"],
                    clear: ["clearFormat", "clearAll"],
                    links: ["createLink", "removeLink"],
                    images: ["image"],
                    tables: ["createTable", "addRowAbove", "addRowBelow", "addColumnLeft", "addColumnRight", "deleteRow", "deleteColumn", "deleteTable"]
                },
                locale: "vi-VN"
            });

            // Form validation
            $("#editForm").validate({
                rules: {
                    TenKhoaHoc: {
                        required: true,
                        minlength: 5,
                        maxlength: 200
                    },
                    Gia: {
                        required: true,
                        min: 0
                    },
                    UserID: {
                        required: true
                    },
                    TrangThai: {
                        required: true
                    },
                    "SelectedCategories[]": {
                        required: true,
                        minlength: 1
                    }
                },
                messages: {
                    TenKhoaHoc: {
                        required: "Vui lòng nhập tên khóa học",
                        minlength: "Tên khóa học phải có ít nhất 5 ký tự",
                        maxlength: "Tên khóa học không được vượt quá 200 ký tự"
                    },
                    Gia: {
                        required: "Vui lòng nhập giá khóa học",
                        min: "Giá không được âm"
                    },
                    UserID: {
                        required: "Vui lòng chọn giảng viên"
                    },
                    TrangThai: {
                        required: "Vui lòng chọn trạng thái khóa học"
                    },
                    "SelectedCategories[]": {
                        required: "Vui lòng chọn ít nhất một danh mục",
                        minlength: "Vui lòng chọn ít nhất một danh mục"
                    }
                },
                errorElement: "div",
                errorClass: "invalid-feedback",
                highlight: function (element) {
                    $(element).addClass("is-invalid").removeClass("is-valid");
                },
                unhighlight: function (element) {
                    $(element).addClass("is-valid").removeClass("is-invalid");
                },
                errorPlacement: function (error, element) {
                    if (element.attr("name") === "SelectedCategories") {
                        error.appendTo("#categoriesError");
                    } else {
                        error.insertAfter(element);
                    }
                },
                submitHandler: function(form) {
                    // Kiểm tra xem người dùng đã chọn ít nhất một danh mục chưa
                    if ($('input[name="SelectedCategories"]:checked').length === 0) {
                        $("#categoriesError").text("Vui lòng chọn ít nhất một danh mục");
                        $('#categories-tab').tab('show');
                        return false;
                    }

                    Swal.fire({
                        title: 'Xác nhận',
                        text: "Bạn có chắc chắn muốn cập nhật khóa học này?",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Đồng ý',
                        cancelButtonText: 'Hủy bỏ'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                    return false;
                }
            });

            // Hiệu ứng Animate.css khi chuyển tab
            $('#courseFormTabs a').on('shown.bs.tab', function (e) {
                $(e.target.getAttribute('href')).addClass('animate__animated animate__fadeIn');
            });

            // Material Design effect for form controls
            $('.form-control, .form-select').each(function() {
                if ($(this).val()) {
                    $(this).parent().addClass('is-filled');
                }
            }).on('focus', function() {
                $(this).parent().addClass('is-focused is-filled');
            }).on('blur', function() {
                $(this).parent().removeClass('is-focused');
                if (!$(this).val()) {
                    $(this).parent().removeClass('is-filled');
                }
            });

            // Xử lý hiển thị thông báo với Toastr
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
                    toastr.success('@TempData["SuccessMessage"]', 'Thành công');
            </text>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <text>
                    toastr.error('@TempData["ErrorMessage"]', 'Lỗi');
            </text>
        }
        });
    </script>
}