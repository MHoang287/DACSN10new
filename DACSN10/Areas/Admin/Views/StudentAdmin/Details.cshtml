@model DACSN10.Areas.Admin.Models.UserAdminViewModel
@{
    ViewData["Title"] = "Chi tiết học viên";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

    var enrollments = ViewBag.Enrollments as List<DACSN10.Models.Enrollment> ?? new List<DACSN10.Models.Enrollment>();
    var payments = ViewBag.Payments as List<DACSN10.Models.Payment> ?? new List<DACSN10.Models.Payment>();
    var favoriteCourses = ViewBag.FavoriteCourses as List<DACSN10.Models.FavoriteCourse> ?? new List<DACSN10.Models.FavoriteCourse>();
    var followings = ViewBag.Followings as List<DACSN10.Models.Follow> ?? new List<DACSN10.Models.Follow>();
}

<div class="container-fluid px-4 animate__animated animate__fadeIn">
    <!-- Header section remains unchanged -->
    <h1 class="mt-4">Chi tiết học viên</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/Admin">Trang chủ</a></li>
        <li class="breadcrumb-item"><a asp-action="Index">Học viên</a></li>
        <li class="breadcrumb-item active">Chi tiết</li>
    </ol>

    <div class="row">
        <div class="col-xl-4">
            <!-- Thông tin cá nhân section remains unchanged -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-user-circle me-1"></i> Thông tin cá nhân
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <img src="https://via.placeholder.com/150" class="rounded-circle img-thumbnail" alt="Avatar" />
                        <h4 class="mt-3">@Model.HoTen</h4>

                        @if (Model.TrangThai == "Active")
                        {
                            <span class="badge bg-success mb-2">Đang hoạt động</span>
                        }
                        else if (Model.TrangThai == "Locked")
                        {
                            <span class="badge bg-danger mb-2">Đã khóa</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary mb-2">Không hoạt động</span>
                        }

                        <p class="text-muted">@Model.Email</p>
                    </div>

                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-mobile-alt me-2"></i> Số điện thoại:</span>
                            <span>@(string.IsNullOrEmpty(Model.PhoneNumber) ? "Chưa cập nhật" : Model.PhoneNumber)</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-calendar-alt me-2"></i> Ngày đăng ký:</span>
                            <span>@Model.NgayDangKy.ToString("dd/MM/yyyy HH:mm")</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-book me-2"></i> Khóa học đã đăng ký:</span>
                            <span class="badge rounded-pill bg-primary">@Model.EnrollmentCount</span>
                        </li>
                    </ul>

                    <div class="d-grid gap-2 mt-3">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                            <i class="fas fa-edit me-1"></i> Chỉnh sửa
                        </a>

                        @if (Model.TrangThai == "Active")
                        {
                            <button type="button" id="lockAccountBtn" class="btn btn-warning">
                                <i class="fas fa-lock me-1"></i> Khóa tài khoản
                            </button>
                        }
                        else if (Model.TrangThai == "Locked")
                        {
                            <button type="button" id="unlockAccountBtn" class="btn btn-success">
                                <i class="fas fa-unlock me-1"></i> Mở khóa tài khoản
                            </button>
                        }

                        <button type="button" id="promoteBtn" class="btn btn-info text-white">
                            <i class="fas fa-user-graduate me-1"></i> Cấp quyền giảng viên
                        </button>
                    </div>
                </div>
            </div>

            <!-- Biểu đồ hoạt động remains mostly unchanged -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i> Hoạt động học tập
                </div>
                <div class="card-body">
                    <div id="activityGauge"></div>
                    <hr />
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h5">@enrollments.Count</div>
                            <div class="small text-muted">Khóa học</div>
                        </div>
                        <div class="col-4">
                            <div class="h5">@payments.Count</div>
                            <div class="small text-muted">Thanh toán</div>
                        </div>
                        <div class="col-4">
                            <div class="h5">@favoriteCourses.Count</div>
                            <div class="small text-muted">Yêu thích</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-8">
            <!-- Tabs nội dung -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="studentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="enrollments-tab" data-bs-toggle="tab" href="#enrollments" role="tab" aria-controls="enrollments" aria-selected="true">
                                <i class="fas fa-graduation-cap me-1"></i> Khóa học đã đăng ký
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="payments-tab" data-bs-toggle="tab" href="#payments" role="tab" aria-controls="payments" aria-selected="false">
                                <i class="fas fa-credit-card me-1"></i> Lịch sử thanh toán
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="favorites-tab" data-bs-toggle="tab" href="#favorites" role="tab" aria-controls="favorites" aria-selected="false">
                                <i class="fas fa-heart me-1"></i> Khóa học yêu thích
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="following-tab" data-bs-toggle="tab" href="#following" role="tab" aria-controls="following" aria-selected="false">
                                <i class="fas fa-user-check me-1"></i> Đang theo dõi
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="studentTabContent">
                        <!-- Khóa học đã đăng ký - Updated property names -->
                        <div class="tab-pane fade show active" id="enrollments" role="tabpanel" aria-labelledby="enrollments-tab">
                            @if (enrollments.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover" id="enrollmentsTable">
                                        <thead>
                                            <tr>
                                                <th>Mã khóa học</th>
                                                <th>Tên khóa học</th>
                                                <th>Ngày đăng ký</th>
                                                <th>Trạng thái</th>
                                                <th>Tiến độ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var enrollment in enrollments)
                                            {
                                                <tr>
                                                    <td>@enrollment.Course.CourseID</td>
                                                    <td>
                                                        <a href="/Admin/CourseAdmin/Details/@enrollment.Course.CourseID" class="text-decoration-none">
                                                            @enrollment.Course.TenKhoaHoc
                                                        </a>
                                                    </td>
                                                    <td>@enrollment.EnrollDate.ToString("dd/MM/yyyy")</td>
                                                    <td>
                                                        @if (enrollment.TrangThai == "Active")
                                                        {
                                                            <span class="badge bg-success">Đang học</span>
                                                        }
                                                        else if (enrollment.TrangThai == "Completed")
                                                        {
                                                            <span class="badge bg-primary">Đã hoàn thành</span>
                                                        }
                                                        else if (enrollment.TrangThai == "Expired")
                                                        {
                                                            <span class="badge bg-danger">Đã hết hạn</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">@enrollment.TrangThai</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <div class="progress">
                                                            <div class="progress-bar" role="progressbar" style="width: @enrollment.Progress%;" aria-valuenow="@enrollment.Progress" aria-valuemin="0" aria-valuemax="100">@enrollment.Progress%</div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Học viên chưa đăng ký khóa học nào.
                                </div>
                            }
                        </div>

                        <!-- Lịch sử thanh toán - Updated property names -->
                        <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payments-tab">
                            @if (payments.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover" id="paymentsTable">
                                        <thead>
                                            <tr>
                                                <th>Mã</th>
                                                <th>Khóa học</th>
                                                <th>Số tiền</th>
                                                <th>Phương thức</th>
                                                <th>Ngày thanh toán</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var payment in payments)
                                            {
                                                <tr>
                                                    <td>@payment.PaymentID</td>
                                                    <td>
                                                        <a href="/Admin/CourseAdmin/Details/@payment.CourseID" class="text-decoration-none">
                                                            @payment.Course.TenKhoaHoc
                                                        </a>
                                                    </td>
                                                    <td>@payment.SoTien.ToString("N0") VNĐ</td>
                                                    <td>@payment.PhuongThucThanhToan</td>
                                                    <td>@payment.NgayThanhToan.ToString("dd/MM/yyyy HH:mm")</td>
                                                    <td>
                                                        @if (payment.Status == PaymentStatus.Success)
                                                        {
                                                            <span class="badge bg-success">Thành công</span>
                                                        }
                                                        else if (payment.Status == PaymentStatus.Failed)
                                                        {
                                                            <span class="badge bg-danger">Thất bại</span>
                                                        }
                                                        else if (payment.Status == PaymentStatus.Pending)
                                                        {
                                                            <span class="badge bg-warning text-dark">Đang xử lý</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">@payment.Status</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Không có lịch sử thanh toán nào.
                                </div>
                            }
                        </div>

                        <!-- Khóa học yêu thích - Need to update missing properties -->
                        <div class="tab-pane fade" id="favorites" role="tabpanel" aria-labelledby="favorites-tab">
                            @if (favoriteCourses.Any())
                            {
                                <div class="row">
                                    @foreach (var favorite in favoriteCourses)
                                    {
                                        <div class="col-md-6 col-lg-4 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h5 class="card-title">@favorite.Course.TenKhoaHoc</h5>
                                                    <p class="card-text small text-truncate">@favorite.Course.MoTa</p>
                                                </div>
                                                <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                                                    <!-- Removed NgayThich - your FavoriteCourse model doesn't have this property -->
                                                    <small class="text-muted">Khóa học yêu thích</small>
                                                    <a href="/Admin/CourseAdmin/Details/@favorite.CourseID" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-info-circle"></i> Chi tiết
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Học viên chưa thêm khóa học yêu thích nào.
                                </div>
                            }
                        </div>

                        <!-- Đang theo dõi - Need to update missing properties -->
                        <div class="tab-pane fade" id="following" role="tabpanel" aria-labelledby="following-tab">
                            @if (followings.Any())
                            {
                                <div class="row">
                                    @foreach (var follow in followings)
                                    {
                                        <div class="col-md-6 col-lg-4 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <img src="https://via.placeholder.com/80" class="rounded-circle mb-3" alt="Avatar" />
                                                    <h5 class="card-title">@follow.FollowedTeacher.HoTen</h5>
                                                    <p class="card-text small text-muted">@follow.FollowedTeacher.Email</p>
                                                </div>
                                                <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                                                    <!-- Removed NgayTheoDoi - your Follow model doesn't have this property -->
                                                    <small class="text-muted">Đang theo dõi</small>
                                                    <a href="/Admin/TeacherAdmin/Details/@follow.FollowedTeacherID" class="btn btn-sm btn-outline-info">
                                                        <i class="fas fa-info-circle"></i> Xem
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Học viên chưa theo dõi giảng viên nào.
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Biểu đồ hoạt động của học viên - Updated property names in JavaScript code -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-line me-1"></i> Biểu đồ hoạt động
                </div>
                <div class="card-body">
                    <canvas id="activityChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Forms ẩn cho các thao tác - Unchanged -->
    <form id="formLockAccount" asp-action="LockAccount" method="post" class="d-none">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />
    </form>

    <form id="formUnlockAccount" asp-action="UnlockAccount" method="post" class="d-none">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />
    </form>

    <form id="formPromoteToTeacher" asp-action="PromoteToTeacher" method="post" class="d-none">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // DataTables
            $("#enrollmentsTable, #paymentsTable").DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json'
                },
                responsive: true,
                pageLength: 5,
                lengthMenu: [[5, 10, 25, -1], [5, 10, 25, "Tất cả"]]
            });

            // Hiệu ứng Animate.css
            $('.card').addClass('animate__animated animate__fadeIn');

            // Biểu đồ hoạt động học tập (Chart.js)
            const enrollmentsByMonth = {};
            const last6Months = [];

            // Tạo mảng 6 tháng gần nhất
            const today = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(today);
                date.setMonth(date.getMonth() - i);
                const monthYear = date.toLocaleDateString('vi-VN', { month: '2-digit', year: 'numeric' });
                last6Months.push(monthYear);
                enrollmentsByMonth[monthYear] = 0;
            }

            // Đếm số khóa học đăng ký theo tháng
        @if (enrollments.Any())
        {
            <text>
                        const enrollments = @Html.Raw(Json.Serialize(enrollments.Select(e => new { NgayDangKy = e.EnrollDate })));

                        enrollments.forEach(enrollment => {
                            const date = new Date(enrollment.ngayDangKy);
                            const monthYear = date.toLocaleDateString('vi-VN', { month: '2-digit', year: 'numeric' });

                            if (enrollmentsByMonth[monthYear] !== undefined) {
                                enrollmentsByMonth[monthYear]++;
                            }
                        });
            </text>
        }

            // Biểu đồ Chart.js
            var ctx = document.getElementById('activityChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last6Months,
                    datasets: [{
                        label: 'Khóa học đăng ký',
                        data: last6Months.map(month => enrollmentsByMonth[month] || 0),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Syncfusion Circular Gauge
            const totalEnrollments = @enrollments.Count;
            const completedEnrollments = @enrollments.Count(e => e.TrangThai == "Completed");
            const percentComplete = totalEnrollments > 0 ? Math.round((completedEnrollments / totalEnrollments) * 100) : 0;

            $("#activityGauge").ejCircularGauge({
                backgroundColor: "transparent",
                width: 250,
                height: 250,
                scales: [{
                    showRanges: true,
                    showLabels: false,
                    pointers: [{
                        value: percentComplete,
                        showBackNeedle: false,
                        backgroundColor: "#0275d8",
                        border: {
                            width: 0
                        },
                        cap: {
                            radius: 8,
                            borderWidth: 0,
                            backgroundColor: "#0275d8"
                        },
                        needleStyle: "rectangle",
                        width: 5,
                        length: 0.8
                    }],
                    labels: [{
                        color: "#8c8c8c"
                    }],
                    ticks: [{
                        type: "major",
                        distanceFromScale: 2,
                        height: 16,
                        width: 1,
                        color: "#8c8c8c"
                    }, {
                        type: "minor",
                        height: 8,
                        width: 1,
                        distanceFromScale: 2,
                        color: "#8c8c8c"
                    }],
                    ranges: [{
                        startValue: 0,
                        endValue: 100,
                        backgroundColor: "#eaeaea",
                        border: { color: "#eaeaea", width: 0 },
                        size: 5
                    }],
                    startAngle: 140,
                    sweepAngle: 260,
                }]
            });

            // Thêm phần trăm vào giữa gauge
            const gaugePercentText = document.createElement("div");
            gaugePercentText.style.position = "absolute";
            gaugePercentText.style.top = "50%";
            gaugePercentText.style.left = "50%";
            gaugePercentText.style.transform = "translate(-50%, -50%)";
            gaugePercentText.style.fontSize = "24px";
            gaugePercentText.style.fontWeight = "bold";
            gaugePercentText.style.color = "#0275d8";
            gaugePercentText.innerHTML = percentComplete + "%";

            document.getElementById("activityGauge").appendChild(gaugePercentText);

            // Animation khi chuyển tab
            $('#studentTabs a').on('shown.bs.tab', function (e) {
                $($(e.target).attr('href')).addClass('animate__animated animate__fadeIn');
            });

            // Xử lý các nút thao tác
            $("#lockAccountBtn").click(function() {
                Swal.fire({
                    title: 'Xác nhận khóa tài khoản',
                    text: `Bạn có chắc chắn muốn khóa tài khoản của học viên "${@Html.Raw(Json.Serialize(Model.HoTen))}"?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $("#formLockAccount").submit();
                    }
                });
            });

            $("#unlockAccountBtn").click(function() {
                Swal.fire({
                    title: 'Xác nhận mở khóa tài khoản',
                    text: `Bạn có chắc chắn muốn mở khóa tài khoản của học viên "${@Html.Raw(Json.Serialize(Model.HoTen))}"?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $("#formUnlockAccount").submit();
                    }
                });
            });

            $("#promoteBtn").click(function() {
                bootbox.confirm({
                    title: "Cấp quyền giảng viên",
                    message: `<p>Bạn có chắc chắn muốn cấp quyền giảng viên cho học viên "${@Html.Raw(Json.Serialize(Model.HoTen))}"?</p>
                               <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> Lưu ý: Hành động này sẽ chuyển học viên thành giảng viên và không thể hoàn tác.</p>`,
                    buttons: {
                        confirm: {
                            label: '<i class="fas fa-check"></i> Xác nhận',
                            className: 'btn-primary'
                        },
                        cancel: {
                            label: '<i class="fas fa-times"></i> Hủy bỏ',
                            className: 'btn-secondary'
                        }
                    },
                    callback: function(result) {
                        if (result) {
                            $("#formPromoteToTeacher").submit();
                        }
                    }
                });
            });
        });
    </script>
}