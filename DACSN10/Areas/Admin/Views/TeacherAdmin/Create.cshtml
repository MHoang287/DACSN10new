@model DACSN10.Areas.Admin.Models.UserAdminViewModel
@{
    ViewData["Title"] = "Thêm giảng viên mới";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid px-4 animate__animated animate__fadeIn">
    <h1 class="mt-4">Thêm giảng viên mới</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/Admin">Trang chủ</a></li>
        <li class="breadcrumb-item"><a asp-action="Index">Giảng viên</a></li>
        <li class="breadcrumb-item active">Thêm mới</li>
    </ol>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-user-plus me-1"></i>
            Thông tin giảng viên mới
            <button type="button" id="showTutorial" class="btn btn-sm btn-outline-info float-end">
                <i class="fas fa-question-circle"></i> Hướng dẫn
            </button>
        </div>
        <div class="card-body">
            <form asp-action="Create" method="post" id="createForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-outline mb-4">
                            <label asp-for="HoTen" class="form-label">Họ tên <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                <input asp-for="HoTen" class="form-control" required data-intro="Nhập họ tên đầy đủ của giảng viên" />
                            </div>
                            <span asp-validation-for="HoTen" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-outline mb-4">
                            <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                <input asp-for="Email" type="email" class="form-control" required data-intro="Email sẽ được sử dụng làm tên đăng nhập" />
                            </div>
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-outline mb-4">
                            <label asp-for="Password" class="form-label">Mật khẩu <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input asp-for="Password" type="password" class="form-control" required id="password" />
                                <button type="button" class="btn btn-outline-secondary" id="togglePassword">
                                    <i class="fas fa-eye" id="toggleIcon"></i>
                                </button>
                            </div>
                            <span asp-validation-for="Password" class="text-danger"></span>
                            <div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar" id="password-strength" role="progressbar"></div>
                            </div>
                            <small class="form-text text-muted" id="password-feedback"></small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-outline mb-4">
                            <label asp-for="ConfirmPassword" class="form-label">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input asp-for="ConfirmPassword" type="password" class="form-control" required />
                            </div>
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-outline mb-4">
                            <label asp-for="PhoneNumber" class="form-label">Số điện thoại</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                <input asp-for="PhoneNumber" class="form-control" data-mask="0000 000 000" placeholder="XXXX XXX XXX" />
                            </div>
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-outline mb-4">
                            <label asp-for="TrangThai" class="form-label">Trạng thái <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-toggle-on"></i></span>
                                <select asp-for="TrangThai" class="form-select" required>
                                    <option value="Active">Hoạt động</option>
                                    <option value="Locked">Đã khóa</option>
                                    <option value="Inactive">Không hoạt động</option>
                                </select>
                            </div>
                            <span asp-validation-for="TrangThai" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <hr />
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="form-outline mb-4">
                            <label class="form-label">Thông tin bổ sung</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-info-circle"></i></span>
                                <textarea name="AdditionalInfo" class="form-control" rows="3" placeholder="Kinh nghiệm, chuyên môn, chứng chỉ,... (nếu có)"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="sendCredentials" />
                    <label class="form-check-label" for="sendCredentials">
                        Gửi thông tin đăng nhập qua email
                    </label>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Trở về danh sách
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // jQuery UI enhancements
            $('select').selectmenu();
            
            // Animate.css effects
            $('.card').addClass('animate__animated animate__fadeIn');
            
            // Material Design effect for inputs
            $('.form-control, .form-select').each(function() {
                if ($(this).val()) {
                    $(this).parent().addClass('is-filled');
                }
            }).on('focusin', function() {
                $(this).parent().addClass('is-focused is-filled');
            }).on('focusout', function() {
                $(this).parent().removeClass('is-focused');
                if (!$(this).val()) {
                    $(this).parent().removeClass('is-filled');
                }
            });
            
            // Form validation
            $("#createForm").validate({
                rules: {
                    HoTen: {
                        required: true,
                        minlength: 3,
                        maxlength: 50
                    },
                    Email: {
                        required: true,
                        email: true
                    },
                    Password: {
                        required: true,
                        minlength: 6
                    },
                    ConfirmPassword: {
                        required: true,
                        equalTo: "#password"
                    },
                    PhoneNumber: {
                        pattern: "(84|0[3|5|7|8|9])+([0-9]{8})"
                    }
                },
                messages: {
                    HoTen: {
                        required: "Vui lòng nhập họ tên",
                        minlength: "Họ tên phải có ít nhất 3 ký tự",
                        maxlength: "Họ tên không được vượt quá 50 ký tự"
                    },
                    Email: {
                        required: "Vui lòng nhập email",
                        email: "Vui lòng nhập địa chỉ email hợp lệ"
                    },
                    Password: {
                        required: "Vui lòng nhập mật khẩu",
                        minlength: "Mật khẩu phải có ít nhất 6 ký tự"
                    },
                    ConfirmPassword: {
                        required: "Vui lòng xác nhận mật khẩu",
                        equalTo: "Xác nhận mật khẩu không khớp"
                    },
                    PhoneNumber: {
                        pattern: "Vui lòng nhập số điện thoại hợp lệ (VD: 0912345678)"
                    }
                },
                errorElement: "div",
                errorClass: "invalid-feedback",
                highlight: function (element) {
                    $(element).addClass("is-invalid").removeClass("is-valid");
                },
                unhighlight: function (element) {
                    $(element).addClass("is-valid").removeClass("is-invalid");
                },
                errorPlacement: function (error, element) {
                    error.insertAfter(element.closest(".input-group"));
                }
            });

            // Toggle password visibility
            $("#togglePassword").click(function () {
                const passwordInput = $("#password");
                const toggleIcon = $("#toggleIcon");
                
                if (passwordInput.attr("type") === "password") {
                    passwordInput.attr("type", "text");
                    toggleIcon.removeClass("fa-eye").addClass("fa-eye-slash");
                } else {
                    passwordInput.attr("type", "password");
                    toggleIcon.removeClass("fa-eye-slash").addClass("fa-eye");
                }
            });
            
            // Password strength meter
            function checkPasswordStrength(password) {
                let strength = 0;
                const feedback = [];
                
                if (password.length === 0) {
                    return { strength: 0, feedback: "Vui lòng nhập mật khẩu" };
                }
                
                if (password.length < 6) {
                    feedback.push("Mật khẩu quá ngắn");
                } else {
                    strength += 20;
                }
                
                if (password.length >= 8) {
                    strength += 10;
                }
                
                if (password.match(/[a-z]+/)) {
                    strength += 15;
                } else {
                    feedback.push("Nên có ít nhất một chữ cái thường");
                }
                
                if (password.match(/[A-Z]+/)) {
                    strength += 15;
                } else {
                    feedback.push("Nên có ít nhất một chữ cái hoa");
                }
                
                if (password.match(/[0-9]+/)) {
                    strength += 15;
                } else {
                    feedback.push("Nên có ít nhất một chữ số");
                }
                
                if (password.match(/[!@@#$%^&*(),.?":{}|<>]+/)) {
                    strength += 25;
                } else {
                    feedback.push("Nên có ít nhất một ký tự đặc biệt");
                }
                
                let message;
                let color;
                
                if (strength < 30) {
                    message = "Yếu";
                    color = "bg-danger";
                } else if (strength < 60) {
                    message = "Trung bình";
                    color = "bg-warning";
                } else if (strength < 80) {
                    message = "Khá mạnh";
                    color = "bg-info";
                } else {
                    message = "Mạnh";
                    color = "bg-success";
                }
                
                if (strength >= 60) {
                    feedback.unshift(`Mật khẩu ${message.toLowerCase()}`);
                } else {
                    feedback.unshift(`Mật khẩu ${message.toLowerCase()}, nên cải thiện thêm`);
                }
                
                return {
                    strength: strength,
                    color: color,
                    feedback: feedback.join(". ")
                };
            }
            
            // Update password strength when typing
            $("#password").on("input", function() {
                const password = $(this).val();
                const result = checkPasswordStrength(password);
                
                $("#password-strength")
                    .removeClass("bg-danger bg-warning bg-info bg-success")
                    .addClass(result.color)
                    .css("width", result.strength + "%");
                    
                $("#password-feedback").text(result.feedback);
            });
            
            // Handle form submission
            $("#createForm").on("submit", function(e) {
                e.preventDefault();
                
                if (!$(this).valid()) {
                    toastr.error("Vui lòng kiểm tra lại thông tin!", "Lỗi");
                    return false;
                }
                
                const passwordStrength = checkPasswordStrength($("#password").val());
                
                if (passwordStrength.strength < 40) {
                    Swal.fire({
                        title: 'Mật khẩu yếu',
                        text: 'Mật khẩu của bạn không đủ mạnh. Bạn vẫn muốn tiếp tục?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Tiếp tục',
                        cancelButtonText: 'Cải thiện mật khẩu'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            submitForm();
                        }
                    });
                } else {
                    submitForm();
                }
                
                return false;
            });
            
            function submitForm() {
                // Check if sendCredentials is checked
                const sendCredentials = $("#sendCredentials").is(":checked");
                
                // Add hidden field for sending credentials if checked
                if (sendCredentials) {
                    $("#createForm").append('<input type="hidden" name="SendCredentials" value="true">');
                }
                
                // Submit the form
                document.getElementById('createForm').submit();
            }
            
            // Hướng dẫn sử dụng với Intro.js
            $('#showTutorial').click(function() {
                introJs().setOptions({
                    steps: [
                        {
                            element: document.querySelector('[asp-for="HoTen"]').closest('.form-outline'),
                            intro: 'Nhập họ tên đầy đủ của giảng viên.'
                        },
                        {
                            element: document.querySelector('[asp-for="Email"]').closest('.form-outline'),
                            intro: 'Nhập địa chỉ email của giảng viên. Email này sẽ được sử dụng làm tên đăng nhập.'
                        },
                        {
                            element: document.querySelector('#password').closest('.form-outline'),
                            intro: 'Nhập mật khẩu cho giảng viên. Hệ thống sẽ kiểm tra độ mạnh của mật khẩu.'
                        },
                        {
                            element: document.querySelector('[asp-for="ConfirmPassword"]').closest('.form-outline'),
                            intro: 'Nhập lại mật khẩu để xác nhận.'
                        },
                        {
                            element: document.querySelector('#sendCredentials').closest('.form-check'),
                            intro: 'Tích vào đây để gửi thông tin đăng nhập tới email của giảng viên.'
                        }
                    ],
                    prevLabel: 'Trước',
                    nextLabel: 'Tiếp',
                    skipLabel: 'Bỏ qua',
                    doneLabel: 'Xong'
                }).start();
            });
        });
    </script>
}