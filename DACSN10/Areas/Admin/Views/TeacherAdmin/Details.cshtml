@model DACSN10.Areas.Admin.Models.UserAdminViewModel
@{
    ViewData["Title"] = "Chi tiết giảng viên";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

    var courses = ViewBag.Courses as List<DACSN10.Models.Course> ?? new List<DACSN10.Models.Course>();
    var followers = ViewBag.Followers as List<DACSN10.Models.Follow> ?? new List<DACSN10.Models.Follow>();
    var studentCount = ViewBag.StudentCount ?? 0;
}

<div class="container-fluid px-4 animate__animated animate__fadeIn">
    <h1 class="mt-4">Chi tiết giảng viên</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/Admin">Trang chủ</a></li>
        <li class="breadcrumb-item"><a asp-action="Index">Giảng viên</a></li>
        <li class="breadcrumb-item active">Chi tiết</li>
    </ol>

    <div class="row">
        <div class="col-xl-4">
            <!-- Thông tin cá nhân -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-user-circle me-1"></i> Thông tin cá nhân
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <img src="https://via.placeholder.com/150" class="rounded-circle img-thumbnail" alt="Avatar" />
                        <h4 class="mt-3">@Model.HoTen</h4>

                        @if (Model.TrangThai == "Active")
                        {
                            <span class="badge bg-success mb-2">Đang hoạt động</span>
                        }
                        else if (Model.TrangThai == "Locked")
                        {
                            <span class="badge bg-danger mb-2">Đã khóa</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary mb-2">Không hoạt động</span>
                        }

                        <p class="text-muted">@Model.Email</p>
                    </div>

                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-mobile-alt me-2"></i> Số điện thoại:</span>
                            <span>@(string.IsNullOrEmpty(Model.PhoneNumber) ? "Chưa cập nhật" : Model.PhoneNumber)</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-calendar-alt me-2"></i> Ngày đăng ký:</span>
                            <span>@Model.NgayDangKy.ToString("dd/MM/yyyy HH:mm")</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-book me-2"></i> Khóa học đã tạo:</span>
                            <span class="badge rounded-pill bg-primary">@Model.CourseCount</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-users me-2"></i> Người theo dõi:</span>
                            <span class="badge rounded-pill bg-info">@Model.FollowerCount</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-user-graduate me-2"></i> Học viên:</span>
                            <span class="badge rounded-pill bg-success">@studentCount</span>
                        </li>
                    </ul>

                    <div class="d-grid gap-2 mt-3">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                            <i class="fas fa-edit me-1"></i> Chỉnh sửa
                        </a>

                        @if (Model.TrangThai == "Active")
                        {
                            <button type="button" id="lockAccountBtn" class="btn btn-warning">
                                <i class="fas fa-lock me-1"></i> Khóa tài khoản
                            </button>
                        }
                        else if (Model.TrangThai == "Locked")
                        {
                            <button type="button" id="unlockAccountBtn" class="btn btn-success">
                                <i class="fas fa-unlock me-1"></i> Mở khóa tài khoản
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Biểu đồ hoạt động -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i> Hiệu quả giảng dạy
                </div>
                <div class="card-body">
                    <div id="teachingGauge"></div>
                    <hr />
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h5">@Model.CourseCount</div>
                            <div class="small text-muted">Khóa học</div>
                        </div>
                        <div class="col-4">
                            <div class="h5">@studentCount</div>
                            <div class="small text-muted">Học viên</div>
                        </div>
                        <div class="col-4">
                            <div class="h5">@Model.FollowerCount</div>
                            <div class="small text-muted">Người theo dõi</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-8">
            <!-- Tabs nội dung -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="teacherTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="courses-tab" data-bs-toggle="tab" href="#courses" role="tab" aria-controls="courses" aria-selected="true">
                                <i class="fas fa-book me-1"></i> Khóa học đã tạo
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="followers-tab" data-bs-toggle="tab" href="#followers" role="tab" aria-controls="followers" aria-selected="false">
                                <i class="fas fa-users me-1"></i> Người theo dõi
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="stats-tab" data-bs-toggle="tab" href="#stats" role="tab" aria-controls="stats" aria-selected="false">
                                <i class="fas fa-chart-bar me-1"></i> Thống kê chi tiết
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="teacherTabContent">
                        <!-- Khóa học đã tạo -->
                        <div class="tab-pane fade show active" id="courses" role="tabpanel" aria-labelledby="courses-tab">
                            @if (courses.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover" id="coursesTable">
                                        <thead>
                                            <tr>
                                                <th>Mã khóa học</th>
                                                <th>Tên khóa học</th>
                                                <th>Ngày tạo</th>
                                                <th>Học phí</th>
                                                <th>Trạng thái</th>
                                                <th>Số lượng học viên</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var course in courses)
                                            {
                                                <tr>
                                                    <td>@course.CourseID</td>
                                                    <td>
                                                        <a href="/Admin/CourseAdmin/Details/@course.CourseID" class="text-decoration-none">
                                                            @course.TenKhoaHoc
                                                        </a>
                                                    </td>
                                                    <td>@course.NgayTao.ToString("dd/MM/yyyy")</td>
                                                    <td>@course.Gia.ToString("N0") VNĐ</td>
                                                    <td>
                                                        @if (course.TrangThai == "Published")
                                                        {
                                                            <span class="badge bg-success">Đã xuất bản</span>
                                                        }
                                                        else if (course.TrangThai == "Draft")
                                                        {
                                                            <span class="badge bg-warning text-dark">Bản nháp</span>
                                                        }
                                                        else if (course.TrangThai == "Archived")
                                                        {
                                                            <span class="badge bg-secondary">Đã lưu trữ</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-primary">@course.TrangThai</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill bg-info">@course.Enrollments?.Count ?? 0</span>
                                                    </td>
                                                    <td>
                                                        <a href="/Admin/CourseAdmin/Details/@course.CourseID" class="btn btn-sm btn-primary">
                                                            <i class="fas fa-info-circle"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Giảng viên chưa tạo khóa học nào.
                                </div>
                            }
                        </div>

                        <!-- Người theo dõi -->
                        <div class="tab-pane fade" id="followers" role="tabpanel" aria-labelledby="followers-tab">
                            @if (followers.Any())
                            {
                                <div class="row row-cols-1 row-cols-md-3 g-4">
                                    @foreach (var follower in followers)
                                    {
                                        <div class="col">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <img src="https://via.placeholder.com/80" class="rounded-circle mb-3" alt="Avatar" />
                                                    <h5 class="card-title">@follower.Follower.HoTen</h5>
                                                    <p class="card-text small">@follower.Follower.Email</p>
                                                </div>
                                                <div class="card-footer bg-white border-0 text-center">
                                                    <a href="/Admin/StudentAdmin/Details/@follower.FollowerID" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-user me-1"></i> Xem thông tin
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>

                                <div class="text-center mt-4">
                                    <a href="#" id="loadMoreFollowers" class="btn btn-outline-secondary">
                                        <i class="fas fa-sync me-1"></i> Xem thêm
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Giảng viên chưa có người theo dõi nào.
                                </div>
                            }
                        </div>

                        <!-- Thống kê chi tiết -->
                        <div class="tab-pane fade" id="stats" role="tabpanel" aria-labelledby="stats-tab">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <i class="fas fa-chart-pie me-1"></i> Phân bố khóa học theo trạng thái
                                        </div>
                                        <div class="card-body">
                                            <canvas id="courseStatusChart" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <i class="fas fa-chart-bar me-1"></i> Số lượng học viên theo khóa học
                                        </div>
                                        <div class="card-body">
                                            <canvas id="enrollmentByCoursesChart" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-chart-line me-1"></i> Xu hướng đăng ký khóa học
                                </div>
                                <div class="card-body">
                                    <canvas id="enrollmentTrendChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Báo cáo tổng hợp -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-line me-1"></i> Báo cáo tổng hợp
                </div>
                <div class="card-body">
                    <div id="teacherDashboard"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Forms ẩn cho các thao tác -->
    <form id="formLockAccount" asp-action="LockAccount" method="post" class="d-none">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />
    </form>

    <form id="formUnlockAccount" asp-action="UnlockAccount" method="post" class="d-none">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // DataTables
            $("#coursesTable").DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json'
                },
                responsive: true,
                pageLength: 5,
                lengthMenu: [[5, 10, 25, -1], [5, 10, 25, "Tất cả"]]
            });

            // Hiệu ứng Animate.css
            $('.card').addClass('animate__animated animate__fadeIn');

            // Xử lý nút khóa/mở khóa tài khoản
            $("#lockAccountBtn").click(function() {
                Swal.fire({
                    title: 'Xác nhận khóa tài khoản',
                    text: `Bạn có chắc chắn muốn khóa tài khoản của giảng viên "${@Html.Raw(Json.Serialize(Model.HoTen))}"?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $("#formLockAccount").submit();
                    }
                });
            });

            $("#unlockAccountBtn").click(function() {
                Swal.fire({
                    title: 'Xác nhận mở khóa tài khoản',
                    text: `Bạn có chắc chắn muốn mở khóa tài khoản của giảng viên "${@Html.Raw(Json.Serialize(Model.HoTen))}"?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $("#formUnlockAccount").submit();
                    }
                });
            });

            // Animation khi chuyển tab
            $('#teacherTabs a').on('shown.bs.tab', function (e) {
                $($(e.target).attr('href')).addClass('animate__animated animate__fadeIn');
            });

            // Syncfusion Circular Gauge cho hiệu quả giảng dạy
            const totalCourses = @Model.CourseCount;
            const totalStudents = @studentCount;
            const totalFollowers = @Model.FollowerCount;

            const teachingEffectiveness = calculateEffectiveness(totalCourses, totalStudents, totalFollowers);

            $("#teachingGauge").ejCircularGauge({
                backgroundColor: "transparent",
                width: 250,
                height: 250,
                scales: [{
                    showRanges: true,
                    showLabels: false,
                    pointers: [{
                        value: teachingEffectiveness,
                        showBackNeedle: false,
                        backgroundColor: "#0275d8",
                        border: {
                            width: 0
                        },
                        cap: {
                            radius: 8,
                            borderWidth: 0,
                            backgroundColor: "#0275d8"
                        },
                        needleStyle: "rectangle",
                        width: 5,
                        length: 0.8
                    }],
                    labels: [{
                        color: "#8c8c8c"
                    }],
                    ticks: [{
                        type: "major",
                        distanceFromScale: 2,
                        height: 16,
                        width: 1,
                        color: "#8c8c8c"
                    }, {
                        type: "minor",
                        height: 8,
                        width: 1,
                        distanceFromScale: 2,
                        color: "#8c8c8c"
                    }],
                    ranges: [{
                        startValue: 0,
                        endValue: 100,
                        backgroundColor: "#eaeaea",
                        border: { color: "#eaeaea", width: 0 },
                        size: 5
                    }],
                    startAngle: 140,
                    sweepAngle: 260,
                }]
            });

            // Thêm phần trăm vào giữa gauge
            const gaugePercentText = document.createElement("div");
            gaugePercentText.style.position = "absolute";
            gaugePercentText.style.top = "50%";
            gaugePercentText.style.left = "50%";
            gaugePercentText.style.transform = "translate(-50%, -50%)";
            gaugePercentText.style.fontSize = "24px";
            gaugePercentText.style.fontWeight = "bold";
            gaugePercentText.style.color = getEffectivenessColor(teachingEffectiveness);
            gaugePercentText.innerHTML = teachingEffectiveness + "%";

            document.getElementById("teachingGauge").appendChild(gaugePercentText);

            function calculateEffectiveness(courses, students, followers) {
                // Công thức đánh giá hiệu quả giảng dạy
                // Tùy chỉnh theo nhu cầu thực tế của hệ thống
                let score = 0;

                if (courses > 0) {
                    // Số khóa học (tối đa 40%)
                    score += Math.min(40, courses * 8);

                    // Số học viên trung bình mỗi khóa (tối đa 40%)
                    const studentsPerCourse = students / courses;
                    score += Math.min(40, studentsPerCourse * 2);

                    // Số người theo dõi (tối đa 20%)
                    score += Math.min(20, followers * 0.5);
                }

                return Math.round(score);
            }

            function getEffectivenessColor(score) {
                if (score < 30) return "#dc3545"; // Đỏ
                if (score < 60) return "#ffc107"; // Vàng
                if (score < 80) return "#0dcaf0"; // Xanh dương nhạt
                return "#198754"; // Xanh lá
            }

            // Biểu đồ phân bố khóa học theo trạng thái
            const courses = @Html.Raw(Json.Serialize(courses));

            const courseStatus = {
                'Đã xuất bản': 0,
                'Bản nháp': 0,
                'Đã lưu trữ': 0,
                'Khác': 0
            };

            courses.forEach(course => {
                if (course.trangThai === 'Published') {
                    courseStatus['Đã xuất bản']++;
                } else if (course.trangThai === 'Draft') {
                    courseStatus['Bản nháp']++;
                } else if (course.trangThai === 'Archived') {
                    courseStatus['Đã lưu trữ']++;
                } else {
                    courseStatus['Khác']++;
                }
            });

            var ctxStatus = document.getElementById("courseStatusChart");
            var courseStatusChart = new Chart(ctxStatus, {
                type: 'pie',
                data: {
                    labels: Object.keys(courseStatus),
                    datasets: [{
                        data: Object.values(courseStatus),
                        backgroundColor: ['#28a745', '#ffc107', '#6c757d', '#17a2b8'],
                        hoverBackgroundColor: ['#218838', '#e0a800', '#5a6268', '#138496'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: {
                        position: 'bottom'
                    }
                }
            });

            // Biểu đồ số lượng học viên theo khóa học
            // Lấy top 5 khóa học có nhiều học viên nhất
            const courseEnrollments = courses
                .map(course => ({
                    name: course.tenKhoaHoc,
                    count: course.enrollments ? course.enrollments.length : 0
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);

            var ctxEnrollment = document.getElementById("enrollmentByCoursesChart");
            var enrollmentChart = new Chart(ctxEnrollment, {
                type: 'horizontalBar',
                data: {
                    labels: courseEnrollments.map(c => c.name),
                    datasets: [{
                        label: 'Số lượng học viên',
                        data: courseEnrollments.map(c => c.count),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        xAxes: [{
                            ticks: {
                                beginAtZero: true,
                                stepSize: 1
                            }
                        }]
                    }
                }
            });

            // Biểu đồ xu hướng đăng ký khóa học (mô phỏng dữ liệu)
            var ctxTrend = document.getElementById("enrollmentTrendChart");
            var trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
                    datasets: [{
                        label: 'Học viên đăng ký mới',
                        data: [12, 19, 3, 5, 2, 3, 20, 25, 10, 15, 8, 12],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                stepSize: 5
                            }
                        }]
                    },
                    title: {
                        display: true,
                        text: 'Xu hướng đăng ký học viên trong 12 tháng gần đây'
                    }
                }
            });

            // Syncfusion Dashboard
            $("#teacherDashboard").ejDashboardLayout({
                columns: 6,
                cellSpacing: [10, 10],
                dashboardCells: [{
                    id: 'courseDistribution',
                    text: 'Phân bố học phí khóa học',
                    row: 0,
                    col: 0,
                    sizeX: 3,
                    sizeY: 2,
                    header: '<div class="e-header-text">Phân bố học phí khóa học</div>',
                    content: '<div id="feeDistributionChart" style="height: 100%; width: 100%;"></div>'
                }, {
                    id: 'topCourses',
                    text: 'Khóa học nổi bật',
                    row: 0,
                    col: 3,
                    sizeX: 3,
                    sizeY: 2,
                    header: '<div class="e-header-text">Khóa học nổi bật</div>',
                    content: createTopCoursesContent()
                }]
            });

            function createTopCoursesContent() {
                // Top 3 khóa học có nhiều học viên nhất
                const topCourses = courseEnrollments.slice(0, 3);

                let html = `<div class="p-2">`;

                if (topCourses.length > 0) {
                    topCourses.forEach((course, index) => {
                        html += `
                        <div class="card mb-2">
                            <div class="card-body p-3">
                                <h5 class="card-title mb-1">${course.name}</h5>
                                <div class="d-flex justify-content-between">
                                    <span class="badge bg-info">${course.count} học viên</span>
                                    <div class="progress-bar-container">
                                        <div class="progress" style="height: 8px; width: 100px;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: ${Math.min(100, course.count * 5)}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                } else {
                    html += `<div class="alert alert-info">Không có dữ liệu khóa học.</div>`;
                }

                html += `</div>`;
                return html;
            }

            // Tạo biểu đồ phân bố học phí
            setTimeout(() => {
                // Nhóm khóa học theo mức học phí
                const feeBrackets = {
                    'Miễn phí': 0,
                    'Dưới 500k': 0,
                    '500k - 1 triệu': 0,
                    '1 - 2 triệu': 0,
                    'Trên 2 triệu': 0
                };

                courses.forEach(course => {
                    const fee = course.hocPhi;
                    if (fee === 0) {
                        feeBrackets['Miễn phí']++;
                    } else if (fee < 500000) {
                        feeBrackets['Dưới 500k']++;
                    } else if (fee < 1000000) {
                        feeBrackets['500k - 1 triệu']++;
                    } else if (fee < 2000000) {
                        feeBrackets['1 - 2 triệu']++;
                    } else {
                        feeBrackets['Trên 2 triệu']++;
                    }
                });

                const pieData = Object.keys(feeBrackets).map(label => {
                    return { x: label, y: feeBrackets[label], text: feeBrackets[label].toString() };
                });

                // Tạo biểu đồ với Syncfusion
                var chart = new ej.charts.AccumulationChart({
                    enableAnimation: true,
                    title: 'Phân bố học phí khóa học',
                    legendSettings: {
                        visible: true,
                        position: 'Bottom'
                    },
                    tooltip: { enable: true, format: '${point.x}: <b>${point.y}</b>' },
                    series: [
                        {
                            dataSource: pieData,
                            xName: 'x',
                            yName: 'y',
                            dataLabel: {
                                visible: true,
                                name: 'text',
                                position: 'Inside'
                            },
                            type: 'Pie'
                        }
                    ]
                });
                chart.appendTo('#feeDistributionChart');
            }, 100);

            // Tooltip cho nút "Xem thêm" người theo dõi
            $("#loadMoreFollowers").click(function(e) {
                e.preventDefault();
                bootbox.alert({
                    title: "Thông báo",
                    message: "Đã hiển thị tất cả người theo dõi",
                    centerVertical: true,
                    buttons: {
                        ok: {
                            label: 'Đã hiểu',
                            className: 'btn-primary'
                        }
                    }
                });
            });
        });
    </script>
}