@model IEnumerable<DACSN10.Models.Quiz>
@{
    ViewData["Title"] = "Quản lý bài kiểm tra";
    Layout = "~/Areas/Teacher/Views/Shared/_TeacherLayout.cshtml";
    var course = ViewBag.Course as DACSN10.Models.Course;
}

@section Styles {
    <link href="~/css/teacher-coursequizzes.css" rel="stylesheet" />
}

<!-- Page Header -->
<div class="page-header" data-aos="fade-down">
    <h1 class="page-title">Quản lý bài kiểm tra</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Teacher")">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("MyCourses", "Teacher")">Khóa học</a></li>
            <li class="breadcrumb-item active">Bài kiểm tra</li>
        </ol>
    </nav>
</div>

<!-- Course Info Header -->
<div class="quiz-header" data-aos="fade-up">
    <div class="course-info">
        <h2 class="course-title-quiz">@course?.TenKhoaHoc</h2>
        <div class="course-meta-quiz">
            <div class="meta-item-quiz">
                <i class="fas fa-book"></i>
                <span>@(course?.Lessons?.Count ?? 0) bài học</span>
            </div>
            <div class="meta-item-quiz">
                <i class="fas fa-users"></i>
                <span>@(course?.Enrollments?.Count ?? 0) học viên</span>
            </div>
            <div class="meta-item-quiz">
                <i class="fas fa-question-circle"></i>
                <span>@Model.Count() bài kiểm tra</span>
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="quiz-stats" data-aos="fade-up" data-aos-delay="100">
    <div class="stat-card-quiz">
        <div class="stat-icon-quiz" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">
            <i class="fas fa-question-circle"></i>
        </div>
        <div class="stat-value-quiz">@Model.Count()</div>
        <div class="stat-label-quiz">Tổng bài kiểm tra</div>
    </div>
    
    <div class="stat-card-quiz">
        <div class="stat-icon-quiz" style="background: linear-gradient(135deg, #10b981, #059669);">
            <i class="fas fa-list"></i>
        </div>
        <div class="stat-value-quiz">@Model.Sum(q => q.Questions?.Count ?? 0)</div>
        <div class="stat-label-quiz">Tổng câu hỏi</div>
    </div>
    
    <div class="stat-card-quiz">
        <div class="stat-icon-quiz" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <i class="fas fa-clipboard-check"></i>
        </div>
        <div class="stat-value-quiz">@Model.Sum(q => q.QuizResults?.Count ?? 0)</div>
        <div class="stat-label-quiz">Lượt làm bài</div>
    </div>
    
    <div class="stat-card-quiz">
        <div class="stat-icon-quiz" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
            <i class="fas fa-percentage"></i>
        </div>
        <div class="stat-value-quiz">
            @{
                var allResults = Model.SelectMany(q => q.QuizResults ?? new List<DACSN10.Models.QuizResult>());
                var avgScore = allResults.Any() ? allResults.Average(r => r.Score) : 0;
            }
            @avgScore.ToString("F1")
        </div>
        <div class="stat-label-quiz">Điểm trung bình</div>
    </div>
</div>

<!-- Quizzes Section -->
<div class="quizzes-container" data-aos="fade-up" data-aos-delay="250">
    <div class="quizzes-header">
        <h3 class="quizzes-title">
            <i class="fas fa-clipboard-check"></i>
            Bài kiểm tra
        </h3>
        <a href="@Url.Action("CreateQuiz", "Teacher", new { courseId = course?.CourseID })" class="add-quiz-btn">
            <i class="fas fa-plus-circle"></i>
            Tạo bài kiểm tra mới
        </a>
    </div>

    @if (course?.Quizzes != null && course.Quizzes.Any())
    {
        <div class="quizzes-list">
            @{
                int quizNumber = 1;
            }
            @foreach (var quiz in course.Quizzes.OrderBy(q => q.QuizID))
            {
                <div class="quiz-item" data-quiz-id="@quiz.QuizID">
                    <!-- Quiz Number Badge -->
                    <div class="quiz-number">
                        @quizNumber
                    </div>

                    <!-- Quiz Content -->
                    <div class="quiz-content">
                        <h4 class="quiz-title">
                            <i class="fas fa-file-alt"></i>
                            @quiz.Title
                        </h4>

                        <div class="quiz-stats">
                            <div class="stat-item">
                                <i class="fas fa-question-circle"></i>
                                <span>@(quiz.Questions?.Count ?? 0) câu hỏi</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-clock"></i>
                                <span>@quiz.DurationMinutes phút</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-users"></i>
                                <span>@(quiz.QuizResults?.Count ?? 0) lượt làm</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quiz Actions -->
                    <div class="quiz-actions">
                        <a href="@Url.Action("EditQuiz", "Teacher", new { id = quiz.QuizID })"
                           class="action-btn btn-edit"
                           title="Chỉnh sửa bài kiểm tra">
                            <i class="fas fa-edit"></i>
                            Chỉnh sửa
                        </a>
                        <button class="action-btn btn-delete"
                                onclick="deleteQuiz(@quiz.QuizID, '@Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(quiz.Title))')"
                                title="Xóa bài kiểm tra">
                            <i class="fas fa-trash-alt"></i>
                            Xóa
                        </button>
                    </div>
                </div>
                quizNumber++;
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-clipboard-question"></i>
            </div>
            <h3>Chưa có bài kiểm tra nào</h3>
            <p>Tạo bài kiểm tra để đánh giá kiến thức học viên của bạn</p>
            <a href="@Url.Action("CreateQuiz", "Teacher", new { courseId = course?.CourseID })" class="add-quiz-btn">
                <i class="fas fa-plus-circle"></i>
                Tạo bài kiểm tra đầu tiên
            </a>
        </div>
    }
</div>

<!-- Additional Actions -->
<div class="text-center mt-4" data-aos="fade-up" data-aos-delay="300">
    <a href="@Url.Action("CourseLessons", "Teacher", new { courseId = course?.CourseID })" class="btn btn-outline-primary me-2">
        <i class="fas fa-book me-2"></i>Quản lý bài học
    </a>
    <a href="@Url.Action("CourseAssignments", "Teacher", new { courseId = course?.CourseID })" class="btn btn-outline-success">
        <i class="fas fa-tasks me-2"></i>Quản lý bài tập
    </a>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2 text-primary"></i>
                    Kết quả bài kiểm tra
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultsContent">
                <!-- Results will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Get anti-forgery token from the hidden input rendered by @Html.AntiForgeryToken()
        function getAntiForgeryToken() {
            var tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenEl ? tokenEl.value : null;
        }

        // Delete quiz via AJAX POST to Teacher/DeleteQuiz
        function deleteQuiz(quizId, quizTitle) {
            if (!quizId) return;
            Swal.fire({
                title: 'Xác nhận xóa',
                html: `Bạn có chắc chắn muốn xóa bài kiểm tra "<strong>${quizTitle}</strong>"?<br><small class="text-danger">Tất cả câu hỏi và kết quả sẽ bị xóa!</small>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '<i class="fas fa-trash me-2"></i>Xóa bài kiểm tra',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (!result.isConfirmed) return;

                Swal.fire({
                    title: 'Đang xóa...',
                    text: 'Vui lòng đợi',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                $.ajax({
                    url: '@Url.Action("DeleteQuiz", "Teacher", new { area = "Teacher" })',
                    type: 'POST',
                    data: {
                        id: quizId,
                        __RequestVerificationToken: getAntiForgeryToken()
                    }
                })
                .done(function (resp) {
                    if (resp && resp.success) {
                        Swal.fire({
                            title: 'Đã xóa!',
                            text: resp.message || 'Bài kiểm tra đã được xóa.',
                            icon: 'success',
                            confirmButtonColor: '#10b981'
                        }).then(() => {
                            // remove quiz element from DOM if desired, or reload
                            // try remove the quiz-item containing this quizId
                            var el = document.querySelector(`[data-quiz-id='${quizId}']`) || document.querySelector(`#questions-${quizId}`);
                            if (el) {
                                // find closest .quiz-item
                                var qi = el.closest('.quiz-item');
                                if (qi) qi.remove();
                                else location.reload();
                            } else {
                                location.reload();
                            }
                        });
                    } else {
                        Swal.fire('Lỗi!', (resp && resp.message) || 'Không thể xóa bài kiểm tra', 'error');
                    }
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    Swal.fire('Lỗi!', 'Có lỗi xảy ra khi xóa bài kiểm tra: ' + (errorThrown || textStatus), 'error');
                });
            });
        }

        // View results: load partial via AJAX GET and inject to modal
        function viewResults(quizId) {
            if (!quizId) return;

            $('#resultsModal').modal('show');
            $('#resultsContent').html('<div class="text-center my-4"><i class="fas fa-spinner fa-spin fa-2x"></i></div>');

            const url = '@Url.Action("QuizResultsPartial", "Teacher", new { area = "Teacher" })' + '?quizId=' + encodeURIComponent(quizId);

            $.get(url)
                .done(function (html) {
                    $('#resultsContent').html(html);
                })
                .fail(function (jqXHR) {
                    var msg = 'Có lỗi khi tải kết quả.';
                    if (jqXHR && jqXHR.responseText) {
                        try {
                            var parsed = JSON.parse(jqXHR.responseText);
                            if (parsed && parsed.message) msg = parsed.message;
                        } catch { /* not JSON */ }
                    }
                    $('#resultsContent').html('<div class="alert alert-danger">' + msg + '</div>');
                });
        }

        // Toggle questions (keep existing)
        function toggleQuestions(quizId) {
            const questionsDiv = $(`#questions-${quizId}`);
            const toggleIcon = $(`#toggle-icon-${quizId}`);
            questionsDiv.slideToggle(300);
            toggleIcon.toggleClass('fa-chevron-down fa-chevron-up');
        }
    </script>

    @Html.AntiForgeryToken()
}