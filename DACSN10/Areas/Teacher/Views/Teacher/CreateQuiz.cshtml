@model DACSN10.Models.Quiz
@{
    ViewData["Title"] = "Tạo bài kiểm tra mới";
    Layout = "~/Areas/Teacher/Views/Shared/_TeacherLayout.cshtml";
    var course = ViewBag.Course as DACSN10.Models.Course;
}

@section Styles {
    <link href="~/css/teacher-createquiz.css" rel="stylesheet" />
}

<div class="page-header">
    <h1>Tạo bài kiểm tra mới</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Teacher")">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("MyCourses", "Teacher")">Khóa học</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("CourseQuizzes", "Teacher", new { courseId = course?.CourseID })">Bài kiểm tra</a></li>
            <li class="breadcrumb-item active">Tạo mới</li>
        </ol>
    </nav>
</div>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible">
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <strong>Lỗi!</strong> @TempData["Error"]
    </div>
}

<div class="card">
    <div class="card-body">
        <form asp-action="CreateQuiz" method="post" id="quizForm">
            @Html.AntiForgeryToken()

            <!-- Hidden CourseID -->
            <input type="hidden" name="CourseID" value="@course?.CourseID" />

            <!-- Step 1: Thông tin cơ bản -->
            <div class="mb-4">
                <h4>Thông tin bài kiểm tra</h4>

                <div class="mb-3">
                    <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                    <input type="text"
                           class="form-control"
                           name="Title"
                           id="Title"
                           placeholder="Nhập tiêu đề bài kiểm tra"
                           required />
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Khóa học</label>
                        <input type="text"
                               class="form-control"
                               value="@course?.TenKhoaHoc"
                               disabled />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Thời gian làm bài</label>
                        <select class="form-control" name="DurationMinutes">
                            <option value="15">15 phút</option>
                            <option value="30" selected>30 phút</option>
                            <option value="45">45 phút</option>
                            <option value="60">60 phút</option>
                            <option value="90">90 phút</option>
                        </select>
                    </div>
                </div>
            </div>

            <hr />

            <!-- Step 2: Câu hỏi -->
            <div class="mb-4">
                <h4>Câu hỏi</h4>
                <div id="questionsContainer">
                    <!-- Questions will be added here -->
                </div>

                <button type="button" class="btn btn-secondary" onclick="addQuestion()">
                    <i class="fas fa-plus"></i> Thêm câu hỏi
                </button>
            </div>

            <hr />

            <!-- Submit buttons -->
            <div class="text-end">
                <a href="@Url.Action("CourseQuizzes", "Teacher", new { courseId = course?.CourseID })"
                   class="btn btn-secondary">
                    Hủy
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Tạo bài kiểm tra
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Template for question -->
<template id="questionTemplate">
    <div class="card mb-3 question-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><strong>Câu hỏi <span class="question-number">1</span></strong></span>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="card-body">
            <!-- Question text -->
            <div class="mb-3">
                <label class="form-label">Nội dung câu hỏi <span class="text-danger">*</span></label>
                <textarea class="form-control"
                          name="questions[0].QuestionText"
                          rows="3"
                          required></textarea>
            </div>

            <!-- Options -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Đáp án A <span class="text-danger">*</span></label>
                    <input type="text"
                           class="form-control"
                           name="questions[0].OptionA"
                           required />
                    <div class="form-check mt-2">
                        <input class="form-check-input"
                               type="radio"
                               name="questions[0].CorrectAnswer"
                               value="A"
                               required />
                        <label class="form-check-label">Đáp án đúng</label>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Đáp án B <span class="text-danger">*</span></label>
                    <input type="text"
                           class="form-control"
                           name="questions[0].OptionB"
                           required />
                    <div class="form-check mt-2">
                        <input class="form-check-input"
                               type="radio"
                               name="questions[0].CorrectAnswer"
                               value="B" />
                        <label class="form-check-label">Đáp án đúng</label>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Đáp án C</label>
                    <input type="text"
                           class="form-control"
                           name="questions[0].OptionC" />
                    <div class="form-check mt-2">
                        <input class="form-check-input"
                               type="radio"
                               name="questions[0].CorrectAnswer"
                               value="C" />
                        <label class="form-check-label">Đáp án đúng</label>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Đáp án D</label>
                    <input type="text"
                           class="form-control"
                           name="questions[0].OptionD" />
                    <div class="form-check mt-2">
                        <input class="form-check-input"
                               type="radio"
                               name="questions[0].CorrectAnswer"
                               value="D" />
                        <label class="form-check-label">Đáp án đúng</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let questionCount = 0;

        // Add first question on page load
        $(document).ready(function() {
            addQuestion();
            console.log('✅ Page loaded, added first question');
        });

        function addQuestion() {
            const template = document.getElementById('questionTemplate');
            const clone = template.content.cloneNode(true);

            // Update question number
            clone.querySelector('.question-number').textContent = questionCount + 1;

            // Update all name attributes with current index
            const textarea = clone.querySelector('textarea');
            textarea.setAttribute('name', `questions[${questionCount}].QuestionText`);

            const inputs = clone.querySelectorAll('input[type="text"]');
            inputs[0].setAttribute('name', `questions[${questionCount}].OptionA`);
            inputs[1].setAttribute('name', `questions[${questionCount}].OptionB`);
            inputs[2].setAttribute('name', `questions[${questionCount}].OptionC`);
            inputs[3].setAttribute('name', `questions[${questionCount}].OptionD`);

            const radios = clone.querySelectorAll('input[type="radio"]');
            radios.forEach(radio => {
                radio.setAttribute('name', `questions[${questionCount}].CorrectAnswer`);
            });

            // Append to container
            document.getElementById('questionsContainer').appendChild(clone);
            questionCount++;

            console.log(`✅ Added question ${questionCount}`);
        }

        function removeQuestion(button) {
            if (questionCount <= 1) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Cảnh báo',
                    text: 'Phải có ít nhất một câu hỏi!'
                });
                return;
            }

            const card = button.closest('.question-card');
            card.remove();
            questionCount--;

            // Re-number remaining questions
            const cards = document.querySelectorAll('.question-card');
            cards.forEach((card, index) => {
                card.querySelector('.question-number').textContent = index + 1;

                // Update name attributes
                const textarea = card.querySelector('textarea');
                textarea.setAttribute('name', `questions[${index}].QuestionText`);

                const textInputs = card.querySelectorAll('input[type="text"]');
                textInputs[0].setAttribute('name', `questions[${index}].OptionA`);
                textInputs[1].setAttribute('name', `questions[${index}].OptionB`);
                textInputs[2].setAttribute('name', `questions[${index}].OptionC`);
                textInputs[3].setAttribute('name', `questions[${index}].OptionD`);

                const radios = card.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    radio.setAttribute('name', `questions[${index}].CorrectAnswer`);
                });
            });

            console.log(`✅ Removed question, count now: ${questionCount}`);
        }

        // Form submission with validation
        $('#quizForm').on('submit', function(e) {
            e.preventDefault();

            // Validate
            const title = $('#Title').val().trim();
            if (!title) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Vui lòng nhập tiêu đề bài kiểm tra!'
                });
                return false;
            }

            if (questionCount === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Vui lòng thêm ít nhất một câu hỏi!'
                });
                return false;
            }

            // Validate each question
            let isValid = true;
            $('.question-card').each(function(index) {
                const questionText = $(this).find('textarea').val().trim();
                const optionA = $(this).find('input[type="text"]').eq(0).val().trim();
                const optionB = $(this).find('input[type="text"]').eq(1).val().trim();
                const correctAnswer = $(this).find('input[type="radio"]:checked').val();

                if (!questionText) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: `Vui lòng nhập nội dung câu hỏi ${index + 1}!`
                    });
                    isValid = false;
                    return false;
                }

                if (!optionA || !optionB) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: `Vui lòng nhập ít nhất 2 đáp án cho câu hỏi ${index + 1}!`
                    });
                    isValid = false;
                    return false;
                }

                if (!correctAnswer) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: `Vui lòng chọn đáp án đúng cho câu hỏi ${index + 1}!`
                    });
                    isValid = false;
                    return false;
                }
            });

            if (!isValid) {
                return false;
            }

            // Confirm before submit
            Swal.fire({
                title: 'Xác nhận',
                text: `Bạn có chắc muốn tạo bài kiểm tra với ${questionCount} câu hỏi?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Tạo bài kiểm tra',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Đang tạo...',
                        text: 'Vui lòng đợi',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    console.log('=== SUBMITTING FORM ===');
                    console.log('Title:', title);
                    console.log('Question count:', questionCount);

                    // Log form data
                    const formData = new FormData(this);
                    console.log('=== FORM DATA ===');
                    for (let pair of formData.entries()) {
                        console.log(pair[0] + ': ' + pair[1]);
                    }

                    // Submit the form normally
                    this.submit();
                }
            });

            return false;
        });
    </script>
}
