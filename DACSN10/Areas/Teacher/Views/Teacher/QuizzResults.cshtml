@model DACSN10.Models.Quiz
@{
    ViewData["Title"] = "Kết quả bài kiểm tra";
    Layout = "~/Areas/Teacher/Views/Shared/_TeacherLayout.cshtml";
}

@section Styles {
    <link href="~/css/teacher-quizresults.css" rel="stylesheet" />
    <style>
        .results-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

            .stat-card:hover {
                transform: translateY(-5px);
            }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .results-table {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .score-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: bold;
        }

        .score-excellent {
            background: #10b981;
            color: white;
        }

        .score-good {
            background: #3b82f6;
            color: white;
        }

        .score-average {
            background: #f59e0b;
            color: white;
        }

        .score-poor {
            background: #ef4444;
            color: white;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .question-analysis {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .question-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }

            .question-stat:last-child {
                border-bottom: none;
            }

        .correct-rate {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .rate-high {
            background: #d4edda;
            color: #155724;
        }

        .rate-medium {
            background: #fff3cd;
            color: #856404;
        }

        .rate-low {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
}

<!-- Results Header -->
<div class="results-header" data-aos="fade-down">
    <h1 class="h2 mb-2">Kết quả: @Model.Title</h1>
    <p class="mb-0">
        <i class="fas fa-book me-2"></i>Khóa học: @Model.Course?.TenKhoaHoc
    </p>
</div>

<!-- Statistics Cards -->
<div class="stats-grid" data-aos="fade-up">
    <div class="stat-card">
        <div class="stat-icon text-primary">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-value">@(Model.QuizResults?.Count ?? 0)</div>
        <div class="stat-label">Tổng lượt làm</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon text-success">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-value">
            @{
                var avgScore = Model.QuizResults?.Any() == true
                ? Model.QuizResults.Average(r => r.Score)
                : 0;
            }
            @avgScore.ToString("F1")
        </div>
        <div class="stat-label">Điểm trung bình</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon text-info">
            <i class="fas fa-trophy"></i>
        </div>
        <div class="stat-value">
            @{
                var maxScore = Model.QuizResults?.Any() == true
                ? Model.QuizResults.Max(r => r.Score)
                : 0;
            }
            @maxScore.ToString("F1")
        </div>
        <div class="stat-label">Điểm cao nhất</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon text-warning">
            <i class="fas fa-percentage"></i>
        </div>
        <div class="stat-value">
            @{
                var passRate = Model.QuizResults?.Any() == true
                ? (Model.QuizResults.Count(r => r.Score >= 50) * 100.0 / Model.QuizResults.Count)
                : 0;
            }
            @passRate.ToString("F0")%
        </div>
        <div class="stat-label">Tỷ lệ đạt</div>
    </div>
</div>

<!-- Score Distribution Chart -->
<div class="chart-container" data-aos="fade-up" data-aos-delay="100">
    <h3 class="mb-3">
        <i class="fas fa-chart-bar me-2 text-primary"></i>
        Phân bố điểm số
    </h3>
    <canvas id="scoreChart" style="max-height: 300px;"></canvas>
</div>

<!-- Results Table -->
<div class="results-table" data-aos="fade-up" data-aos-delay="200">
    <h3 class="mb-3">
        <i class="fas fa-list me-2 text-primary"></i>
        Chi tiết kết quả
    </h3>

    @if (Model.QuizResults != null && Model.QuizResults.Any())
    {
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Học viên</th>
                        <th>Email</th>
                        <th>Điểm số</th>
                        <th>Xếp loại</th>
                        <th>Thời gian làm</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int index = 1;
                        foreach (var result in Model.QuizResults.OrderByDescending(r => r.Score))
                        {
                            <tr>
                                <td>@index</td>
                                <td>
                                    <strong>@result.User?.HoTen</strong>
                                </td>
                                <td>@result.User?.Email</td>
                                <td>
                                    <span class="score-badge
                                                    @(result.Score >= 80 ? "score-excellent" :
                                                                                    result.Score >= 60 ? "score-good" :
                                                                                    result.Score >= 40 ? "score-average" : "score-poor")">
                            @result.Score.ToString("F1")
                        </span>
                    </td>
                    <td>
                        @if (result.Score >= 80)
                                    {
                                        <span class="badge bg-success">Xuất sắc</span>
                                    }
                                    else if (result.Score >= 60)
                                    {
                                        <span class="badge bg-primary">Tốt</span>
                                    }
                                    else if (result.Score >= 40)
                                    {
                                        <span class="badge bg-warning">Trung bình</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Yếu</span>
                                    }
                                </td>
                                <td>@result.TakenAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary"
                                            onclick="viewDetailResult(@result.ResultID)"
                                            data-bs-toggle="tooltip"
                                            title="Xem chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            index++;
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- Export Buttons -->
        <div class="mt-3 text-end">
            <button class="btn btn-success" onclick="exportToExcel()">
                <i class="fas fa-file-excel me-2"></i>Xuất Excel
            </button>
            <button class="btn btn-danger" onclick="exportToPDF()">
                <i class="fas fa-file-pdf me-2"></i>Xuất PDF
            </button>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
            <h5>Chưa có kết quả nào</h5>
            <p class="text-muted">Chưa có học viên nào làm bài kiểm tra này</p>
        </div>
    }
</div>

<!-- Question Analysis -->
<div class="question-analysis" data-aos="fade-up" data-aos-delay="300">
    <h3 class="mb-3">
        <i class="fas fa-chart-pie me-2 text-primary"></i>
        Phân tích câu hỏi
    </h3>

    @if (Model.Questions != null && Model.Questions.Any())
    {
        <div class="question-stats">
            @{
                int questionIndex = 1;
                foreach (var question in Model.Questions.OrderBy(q => q.QuestionID))
                {
                    // Tính tỷ lệ trả lời đúng (giả định - cần thêm logic thực tế)
                    var correctRate = new Random().Next(30, 90); // Placeholder

                    <div class="question-stat">
                        <div>
                            <strong>Câu @questionIndex:</strong>
                            <span class="text-muted">@question.QuestionText.Substring(0, Math.Min(50, question.QuestionText.Length))...</span>
                        </div>
                        <div>
                            <span class="correct-rate @(correctRate >= 70 ? "rate-high" : correctRate >= 40 ? "rate-medium" : "rate-low")">
                                @correctRate% trả lời đúng
                            </span>
                        </div>
                    </div>
                    questionIndex++;
                }
            }
        </div>
    }
</div>

<!-- Back Button -->
<div class="mt-4" data-aos="fade-up" data-aos-delay="400">
    <a href="@Url.Action("CourseQuizzes", "Teacher", new { courseId = Model.CourseID })"
       class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Quay lại
    </a>
    <a href="@Url.Action("EditQuiz", "Teacher", new { id = Model.QuizID })"
       class="btn btn-warning">
        <i class="fas fa-edit me-2"></i>Chỉnh sửa bài kiểm tra
    </a>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize Chart.js
        $(document).ready(function() {
            // Score distribution chart
            const ctx = document.getElementById('scoreChart').getContext('2d');

            @if (Model.QuizResults != null && Model.QuizResults.Any())
            {
                    <text>
                    // Calculate score distribution
                    const scoreRanges = [
                        { label: '0-20', min: 0, max: 20, count: 0 },
                        { label: '20-40', min: 20, max: 40, count: 0 },
                        { label: '40-60', min: 40, max: 60, count: 0 },
                        { label: '60-80', min: 60, max: 80, count: 0 },
                        { label: '80-100', min: 80, max: 100, count: 0 }
                    ];

                    @foreach (var result in Model.QuizResults)
                    {
                            <text>
                            if (@result.Score >= 80) scoreRanges[4].count++;
                            else if (@result.Score >= 60) scoreRanges[3].count++;
                            else if (@result.Score >= 40) scoreRanges[2].count++;
                            else if (@result.Score >= 20) scoreRanges[1].count++;
                            else scoreRanges[0].count++;
                            </text>
                    }

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: scoreRanges.map(r => r.label),
                            datasets: [{
                                label: 'Số lượng học viên',
                                data: scoreRanges.map(r => r.count),
                                backgroundColor: [
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(139, 92, 246, 0.8)'
                                ],
                                borderColor: [
                                    'rgba(239, 68, 68, 1)',
                                    'rgba(245, 158, 11, 1)',
                                    'rgba(59, 130, 246, 1)',
                                    'rgba(16, 185, 129, 1)',
                                    'rgba(139, 92, 246, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                    </text>
            }

            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
        });

        function viewDetailResult(resultId) {
            // Implement view detail logic
            window.location.href = `/Teacher/ResultDetail/${resultId}`;
        }

        function exportToExcel() {
            // Implement export to Excel
            toastr.info('Đang xuất file Excel...');
            window.location.href = '@Url.Action("ExportQuizResultsExcel", "Teacher", new { quizId = Model.QuizID })';
        }

        function exportToPDF() {
            // Implement export to PDF
            toastr.info('Đang xuất file PDF...');
            window.location.href = '@Url.Action("ExportQuizResultsPDF", "Teacher", new { quizId = Model.QuizID })';
        }
    </script>
}
