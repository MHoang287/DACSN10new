@using DACSN10.Areas.Teacher.ViewModels
@model TeacherReportViewModel
@using System.Text.Json

@{
    ViewData["Title"] = "Báo cáo & Phân tích";
    Layout = "~/Areas/Teacher/Views/Shared/_TeacherLayout.cshtml";
    var selectedPeriod = (string)(ViewBag.Period ?? "30d");
}

@section Styles {
    <style>
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(230px,1fr));
            gap: 1.2rem;
            margin-bottom: 1.5rem
        }

        .summary-card {
            background: #fff;
            border-radius: 14px;
            padding: 1rem 1.25rem;
            box-shadow: 0 4px 12px rgba(0,0,0,.07)
        }

        .summary-icon {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.2rem;
            margin-bottom: .5rem
        }

        .summary-value {
            font-size: 1.55rem;
            font-weight: 700;
            margin: 0;
            color: #0f172a
        }

        .summary-label {
            font-size: .75rem;
            font-weight: 600;
            color: #64748b;
            letter-spacing: .5px;
            text-transform: uppercase
        }

        .report-section {
            background: #fff;
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 6px 18px rgba(0,0,0,.06)
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem
        }

        .section-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: .6rem
        }

        .filters {
            display: flex;
            gap: .5rem;
            align-items: center
        }

        .performance-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0
        }

            .performance-table th {
                background: #f8fafc;
                padding: .65rem .75rem;
                font-size: .7rem;
                text-transform: uppercase;
                font-weight: 600;
                color: #475569
            }

            .performance-table td {
                padding: .6rem .75rem;
                border-bottom: 1px solid #f1f5f9;
                font-size: .8rem;
                color: #334155;
                vertical-align: middle
            }

        .status-badge {
            padding: .25rem .55rem;
            border-radius: 18px;
            font-size: .55rem;
            font-weight: 600;
            text-transform: uppercase
        }

        .status-active {
            background: #dcfce7;
            color: #15803d
        }

        .status-pending {
            background: #fef9c3;
            color: #d97706
        }

        .status-inactive {
            background: #f1f5f9;
            color: #64748b
        }

        .progress-bar-custom {
            height: 6px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg,#3b82f6,#1d4ed8)
        }

        .chart-container {
            height: 360px;
            position: relative
        }

        .mini-chart-container {
            height: 280px
        }

        .distribution-legend {
            display: flex;
            flex-wrap: wrap;
            gap: .6rem;
            margin-top: .75rem
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: .4rem;
            font-size: .7rem
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px
        }

        .empty-hint {
            font-size: .75rem;
            color: #64748b;
            margin-top: .5rem
        }

        .rating-note {
            font-size: .65rem;
            color: #64748b;
            margin-top: .25rem
        }
    </style>
}

<div class="page-header" data-aos="fade-down">
    <h1 class="page-title">Báo cáo & Phân tích</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Teacher")">Dashboard</a></li>
            <li class="breadcrumb-item active">Báo cáo</li>
        </ol>
    </nav>
</div>

<!-- Bộ lọc kỳ thời gian -->
<div class="report-section" data-aos="fade-up">
    <div class="section-header">
        <h3 class="section-title"><i class="fas fa-filter text-primary"></i>Khoảng thời gian</h3>
        <div class="filters">
            <select id="periodSelect" class="form-select form-select-sm" onchange="onPeriodChange(this.value)">
                <option value="30d" @(selectedPeriod == "30d" ? "selected" : "")>30 ngày qua</option>
                <option value="month" @(selectedPeriod == "month" ? "selected" : "")>Tháng hiện tại</option>
                <option value="prev-month" @(selectedPeriod == "prev-month" ? "selected" : "")>Tháng trước</option>
                <option value="range" @(selectedPeriod == "range" ? "selected" : "")>Khoảng ngày...</option>
            </select>
            <input type="date" id="rangeStart" class="form-control form-control-sm" style="display:@(selectedPeriod == "range" ? "block" : "none")" />
            <input type="date" id="rangeEnd" class="form-control form-control-sm" style="display:@(selectedPeriod == "range" ? "block" : "none")" />
            <button id="applyRange" class="btn btn-sm btn-primary" style="display:@(selectedPeriod == "range" ? "inline-block" : "none")" onclick="applyRange()">Áp dụng</button>
        </div>
    </div>

    <div class="summary-cards">
        <div class="summary-card">
            <div class="summary-icon" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8)"><i class="fas fa-chart-line"></i></div>
            <div class="summary-value">@Model.Summary.PeriodRevenue.ToString("N0")₫</div>
            <div class="summary-label">Doanh thu (@Model.Summary.PeriodLabel)</div>
        </div>
        <div class="summary-card">
            <div class="summary-icon" style="background:linear-gradient(135deg,#10b981,#059669)"><i class="fas fa-user-plus"></i></div>
            <div class="summary-value">@Model.Summary.PeriodNewStudents</div>
            <div class="summary-label">Học viên mới (@Model.Summary.PeriodLabel)</div>
        </div>
        <div class="summary-card">
            <div class="summary-icon" style="background:linear-gradient(135deg,#f59e0b,#d97706)"><i class="fas fa-star"></i></div>
            <div class="summary-value">@Model.Summary.AverageRating.ToString("F1")/5</div>
            <div class="summary-label">Đánh giá TB</div>
            @if (Model.Summary.AverageRating == 0)
            {
                <div class="rating-note">Chưa có dữ liệu Quiz để tính rating</div>
            }
        </div>
        <div class="summary-card">
            <div class="summary-icon" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)"><i class="fas fa-graduation-cap"></i></div>
            <div class="summary-value">@Model.Summary.GlobalCompletionRate.ToString("F1")%</div>
            <div class="summary-label">Tỷ lệ hoàn thành</div>
        </div>
    </div>
</div>

<!-- Biểu đồ doanh thu 6 tháng -->
<div class="report-section" data-aos="fade-up" data-aos-delay="100">
    <div class="section-header">
        <h3 class="section-title"><i class="fas fa-dollar-sign text-success"></i>Biểu đồ doanh thu 6 tháng</h3>
    </div>
    <div class="chart-container"><canvas id="revenueChart"></canvas></div>
    @if (!Model.MonthlyRevenue.Any())
    {
        <div class="empty-hint">Chưa có giao dịch thành công trong 6 tháng gần đây.</div>
    }
</div>

<!-- Hiệu suất khóa học -->
<div class="report-section" data-aos="fade-up" data-aos-delay="140">
    <div class="section-header">
        <h3 class="section-title"><i class="fas fa-trophy text-warning"></i>Hiệu suất khóa học</h3>
    </div>
    @if (Model.CoursePerformance.Any())
    {
        <div class="table-responsive">
            <table class="performance-table">
                <thead>
                    <tr>
                        <th>Khóa học</th>
                        <th>Trạng thái</th>
                        <th>HV (lifetime)</th>
                        <th>HV (@Model.Summary.PeriodLabel)</th>
                        <th>Doanh thu lifetime</th>
                        <th>Doanh thu (@Model.Summary.PeriodLabel)</th>
                        <th>Tiến độ TB</th>
                        <th>Hoàn thành (%)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in Model.CoursePerformance)
                    {
                        <tr>
                            <td><strong>@c.TenKhoaHoc</strong></td>
                            <td><span class="status-badge status-@c.TrangThai?.ToLower()">@c.TrangThai</span></td>
                            <td>@c.TotalStudents</td>
                            <td>@c.PeriodNewStudents</td>
                            <td>@c.TotalRevenue.ToString("N0")₫</td>
                            <td>@c.PeriodRevenue.ToString("N0")₫</td>
                            <td>
                                <div class="progress-bar-custom"><div class="progress-fill" style="width:@c.AverageProgress.ToString("F0")%"></div></div>
                                <small>@c.AverageProgress.ToString("F1")%</small>
                            </td>
                            <td>@c.CompletionRateCourse.ToString("F1")%</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <p class="text-muted">Chưa có khóa học nào.</p>
    }
</div>

<div class="row">
    <div class="col-lg-6" data-aos="fade-up" data-aos-delay="180">
        <div class="report-section">
            <div class="section-header"><h3 class="section-title"><i class="fas fa-users text-info"></i>Phân tích học viên (4 tuần)</h3></div>
            <div class="mini-chart-container"><canvas id="studentAnalyticsChart"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6" data-aos="fade-up" data-aos-delay="200">
        <div class="report-section">
            <div class="section-header"><h3 class="section-title"><i class="fas fa-tags text-purple"></i>Phân bố theo danh mục</h3></div>
            <div class="mini-chart-container"><canvas id="categoryChart"></canvas></div>
            <div id="categoryLegend" class="distribution-legend"></div>
            @if (!Model.CategoryDistribution.Any())
            {
                <div class="empty-hint">Chưa có khóa học nào gắn danh mục.</div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        function onPeriodChange(val){
            if(val === 'range'){
                document.getElementById('rangeStart').style.display='block';
                document.getElementById('rangeEnd').style.display='block';
                document.getElementById('applyRange').style.display='inline-block';
            }else{
                window.location = `@Url.Action("TeacherReports", "Teacher", new { area = "Teacher" })?period=${val}`;
            }
        }
        function applyRange(){
            const s = document.getElementById('rangeStart').value;
            const e = document.getElementById('rangeEnd').value;
            if(!s || !e){ alert('Chọn đủ ngày bắt đầu/kết thúc'); return; }
            window.location = `@Url.Action("TeacherReports", "Teacher", new { area = "Teacher" })?period=range&start=${s}&end=${e}`;
        }

        const monthlyRevenue = @Html.Raw(JsonSerializer.Serialize(Model.MonthlyRevenue));
        const weeklyAnalytics = @Html.Raw(JsonSerializer.Serialize(Model.WeeklyAnalytics));
        const categoryDistribution = @Html.Raw(JsonSerializer.Serialize(Model.CategoryDistribution));

        // Revenue chart (6 tháng)
        const revLabels = monthlyRevenue.map(r => `T${r.Month}/${r.Year}`);
        const revData = monthlyRevenue.map(r => r.Revenue);
        new Chart(document.getElementById('revenueChart'), {
            type: 'line',
            data: {
                labels: revLabels,
                datasets: [{
                    label: 'Doanh thu (₫)',
                    data: revData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59,130,246,0.15)',
                    borderWidth: 3,
                    pointRadius: 4,
                    tension: .35,
                    fill: true
                }]
            },
            options: {
                responsive:true,
                maintainAspectRatio:false,
                plugins:{ legend:{ display:false } },
                scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>v.toLocaleString('vi-VN')+'₫' } } }
            }
        });

        // Weekly analytics
        const weekLabels = weeklyAnalytics.map(w => w.Label);
        new Chart(document.getElementById('studentAnalyticsChart'), {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: [
                    { label:'Học viên mới', data: weeklyAnalytics.map(w=>w.NewStudents), backgroundColor:'rgba(59,130,246,.8)' },
                    { label:'Hoàn thành', data: weeklyAnalytics.map(w=>w.CompletedStudents), backgroundColor:'rgba(16,185,129,.8)' }
                ]
            },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true, precision:0 } } }
        });

        // Category distribution
        const catColors = ['#6366f1','#10b981','#f59e0b','#ef4444','#8b5cf6','#0ea5e9','#84cc16','#ec4899'];
        const catData = { labels: categoryDistribution.map(c=>c.CategoryName),
                          datasets:[{ data: categoryDistribution.map(c=>c.CourseCount), backgroundColor: catColors.slice(0, categoryDistribution.length), borderWidth:0 }] };
        new Chart(document.getElementById('categoryChart'), { type:'doughnut', data: catData, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } } });

        const legend = document.getElementById('categoryLegend');
        categoryDistribution.forEach((c,i)=>{
            const el=document.createElement('div');
            el.className='legend-item';
            el.innerHTML=`<span class="legend-color" style="background:${catColors[i%catColors.length]}"></span>
                          <span><strong>${c.CategoryName}</strong> • ${c.CourseCount} KH • ${c.StudentCount} HV • ${c.Revenue.toLocaleString('vi-VN')}₫</span>`;
            legend.appendChild(el);
        });
    </script>
}