@model DACSN10.Models.Course
@{
    ViewData["Title"] = Model?.TenKhoaHoc ?? "Chi tiết khóa học";
}

<div class="container animate__animated animate__fadeIn">
    @if (Model == null)
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i> Không tìm thấy khóa học
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
                        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Course")">Khóa học</a></li>
                        <li class="breadcrumb-item active" aria-current="page">@Model.TenKhoaHoc</li>
                    </ol>
                </nav>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex justify-content-end">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <form asp-area="" asp-controller="Course" asp-action="FollowCourse" method="post" class="me-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="courseId" value="@Model.CourseID" />
                            <button type="submit" class="btn btn-outline-primary btn-sm">
                                <i class="far fa-bell me-1"></i> Theo dõi
                            </button>
                        </form>
                        <form asp-action="AddToFavorite" method="post" class="me-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="courseId" value="@Model.CourseID" />
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="far fa-heart me-1"></i> Yêu thích
                            </button>
                        </form>
                    }
                    <a href="#" class="btn btn-outline-secondary btn-sm share-course" data-url="@Url.Action("Details", "Course", new { id = Model.CourseID }, Context.Request.Scheme)">
                        <i class="fas fa-share-alt me-1"></i> Chia sẻ
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Chi tiết khóa học -->
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h1 class="card-title fw-bold mb-3">@Model.TenKhoaHoc</h1>
                        <div class="d-flex align-items-center mb-3">
                            <div>
                                <div>Giảng viên: <a href="/User/TeacherProfile/@Model.UserID">@Model.User?.HoTen</a></div>
                                <div class="text-muted small">Ngày tạo: @Model.NgayTao.ToString("dd/MM/yyyy")</div>
                            </div>
                        </div>

                        <!-- Hiển thị danh mục -->
                        @if (Model.CourseCategories != null && Model.CourseCategories.Any())
                        {
                            <div class="mb-3">
                                @foreach (var cc in Model.CourseCategories)
                                {
                                    <a href="@Url.Action("SearchByCategory", new { categoryId = cc.CategoryID })" class="badge bg-secondary me-1">
                                        @cc.Category?.Name
                                    </a>
                                }
                            </div>
                        }

                        <!-- Nút đăng ký khóa học -->
                        <div class="mb-4">
                            <form asp-action="Enroll" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="courseId" value="@Model.CourseID" />
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-graduation-cap me-1"></i> Đăng ký khóa học
                                </button>
                                <a href="@Url.Action("PreviewVideo", new { courseId = Model.CourseID })" class="btn btn-outline-primary ms-2">
                                    <i class="fas fa-play-circle me-1"></i> Xem thử
                                </a>
                            </form>
                        </div>

                        <!-- Thông tin chi tiết -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="description-tab" data-bs-toggle="tab" href="#description" role="tab">Mô tả</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="lessons-tab" data-bs-toggle="tab" href="#lessons" role="tab">Bài học</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="requirements-tab" data-bs-toggle="tab" href="#requirements" role="tab">Yêu cầu</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content">
                                    <!-- Tab Mô tả -->
                                    <div class="tab-pane fade show active" id="description" role="tabpanel">
                                        <div class="course-description">
                                            @Html.Raw(Model.MoTa)
                                        </div>
                                    </div>

                                    <!-- Tab Bài học -->
                                    <div class="tab-pane fade" id="lessons" role="tabpanel">
                                        @if (Model.Lessons != null && Model.Lessons.Any())
                                        {
                                            <div class="list-group">
                                                @foreach (var lesson in Model.Lessons)
                                                {
                                                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <div class="fw-bold"><i class="fas fa-play-circle me-2"></i> @lesson.TenBaiHoc</div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i> Chưa có bài học nào được thêm vào khóa học này.
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar thông tin bên phải -->
            <div class="col-md-4">
                <!-- Ảnh khóa học -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Thông tin khóa học</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-users me-2"></i> Học viên:</span>
                                <span class="badge bg-primary rounded-pill">@(Model.Enrollments?.Count ?? 0)</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list-ol me-2"></i> Số bài học:</span>
                                <span>@(Model.Lessons?.Count ?? 0)</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Giảng viên -->
                @if (Model.User != null)
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Thông tin giảng viên</h5>
                            <div class="d-flex align-items-center mb-3">
                                <div>
                                    <h6 class="mb-0">@Model.User.HoTen</h6>
                                </div>
                            </div>
                            <a href="/User/TeacherProfile/@Model.UserID" class="btn btn-outline-primary btn-sm w-100">
                                <i class="fas fa-user me-1"></i> Xem hồ sơ giảng viên
                            </a>
                        </div>
                    </div>
                }

                <!-- Khóa học liên quan -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Có thể bạn quan tâm</h5>
                        <div id="relatedCourses" class="mt-3">
                            <div class="placeholder-glow">
                                <span class="placeholder col-12 mb-2"></span>
                                <span class="placeholder col-12 mb-2"></span>
                                <span class="placeholder col-12 mb-2"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modal chia sẻ khóa học -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Chia sẻ khóa học</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="courseUrl" class="form-label">Đường dẫn khóa học</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="courseUrl" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="d-flex justify-content-center gap-3 mt-4">
                    <a href="#" id="shareFacebook" class="btn btn-primary btn-lg" target="_blank">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="#" id="shareTwitter" class="btn btn-info btn-lg text-white" target="_blank">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" id="shareLinkedIn" class="btn btn-primary btn-lg" target="_blank">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a href="#" id="shareWhatsapp" class="btn btn-success btn-lg" target="_blank">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Xử lý nút chia sẻ
            $(".share-course").on("click", function(e) {
                e.preventDefault();
                var url = $(this).data("url");
                $("#courseUrl").val(url);
                $("#shareFacebook").attr("href", "https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(url));
                $("#shareTwitter").attr("href", "https://twitter.com/intent/tweet?url=" + encodeURIComponent(url) + "&text=" + encodeURIComponent("@Model.TenKhoaHoc"));
                $("#shareLinkedIn").attr("href", "https://www.linkedin.com/sharing/share-offsite/?url=" + encodeURIComponent(url));
                $("#shareWhatsapp").attr("href", "https://wa.me/?text=" + encodeURIComponent("@Model.TenKhoaHoc " + url));

                var shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
                shareModal.show();
            });

            // Xử lý sao chép đường dẫn
            $("#copyLinkBtn").on("click", function() {
                var copyText = document.getElementById("courseUrl");
                copyText.select();
                document.execCommand("copy");
                toastr.success("Đã sao chép đường dẫn vào clipboard!");
            });

            // Tải khóa học liên quan
            $.ajax({
                url: '@Url.Action("SearchByCategory", "Course", new { categoryId = Model.CourseCategories?.FirstOrDefault()?.CategoryID })',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    var relatedCoursesHtml = '';
                    var courses = data.filter(function(course) {
                        return course.CourseID !== @Model.CourseID;
                    }).slice(0, 3);

                    if (courses.length > 0) {
                        courses.forEach(function(course) {
                            relatedCoursesHtml += `
                                <div class="d-flex mb-3 course-item">
                                    <img src="${course.HinhAnh || '/images/default-course.jpg'}" class="rounded me-2" width="50" height="50" alt="${course.TenKhoaHoc}" style="object-fit: cover;">
                                    <div>
                                        <a href="/Course/Details/${course.CourseID}" class="text-decoration-none">
                                            <h6 class="mb-0">${course.TenKhoaHoc}</h6>
                                        </a>
                                        <small class="text-muted">${course.CapDo || 'Cơ bản'}</small>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        relatedCoursesHtml = '<div class="alert alert-info">Không có khóa học liên quan.</div>';
                    }

                    $("#relatedCourses").html(relatedCoursesHtml);
                },
                error: function() {
                    $("#relatedCourses").html('<div class="alert alert-warning">Không thể tải khóa học liên quan.</div>');
                }
            });

            // Hiệu ứng khi cuộn trang
            $(window).scroll(function() {
                var windowHeight = $(window).height();
                var windowTop = $(window).scrollTop();

                $(".card").each(function() {
                    var elementTop = $(this).offset().top;
                    if (elementTop < windowTop + windowHeight - 100) {
                        $(this).addClass("animate__animated animate__fadeInUp");
                    }
                });
            });

            // Tạo tour giới thiệu với Intro.js
            function startTour() {
                var intro = introJs();
                intro.setOptions({
                    steps: [
                        {
                            element: document.querySelector('.breadcrumb'),
                            intro: 'Đây là đường dẫn điều hướng, giúp bạn quay lại trang trước đó.',
                            position: 'bottom'
                        },
                        {
                            element: document.querySelector('.btn-primary'),
                            intro: 'Nhấn vào đây để đăng ký khóa học.',
                            position: 'right'
                        },
                        {
                            element: document.querySelector('#description-tab'),
                            intro: 'Xem thông tin chi tiết về khóa học tại đây.',
                            position: 'bottom'
                        },
                        {
                            element: document.querySelector('#lessons-tab'),
                            intro: 'Xem danh sách các bài học trong khóa học.',
                            position: 'bottom'
                        }
                    ],
                    nextLabel: 'Tiếp',
                    prevLabel: 'Quay lại',
                    skipLabel: 'Bỏ qua',
                    doneLabel: 'Hoàn thành'
                });
                intro.start();
            }

            // Hiển thị nút tour
            $('<button class="btn btn-sm btn-info position-fixed" style="bottom: 20px; left: 20px; z-index: 1000;"><i class="fas fa-question-circle me-1"></i> Hướng dẫn</button>')
                .appendTo('body')
                .on('click', startTour);
        });
    </script>
}