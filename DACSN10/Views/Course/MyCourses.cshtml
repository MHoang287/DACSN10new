@model List<dynamic>
@{
    ViewData["Title"] = "Khóa học của tôi - OnlineLearning";
    var totalPages = ViewBag.TotalPages ?? 1;
    var currentPage = ViewBag.Page ?? 1;
    var totalCourses = ViewBag.TotalCourses ?? 0;
}

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" />
	<link rel="stylesheet" href="~/css/MyCourses.css" />
}

<!-- Dashboard Header -->
<section class="dashboard-header">
    <div class="container-fluid px-4 px-md-5">
        <div class="text-center" data-aos="fade-up">
            <h1 class="display-5 fw-bold mb-3">
                <i class="fas fa-graduation-cap me-3"></i>Khóa học của tôi
            </h1>
            <p class="fs-5 mb-0">
                Quản lý và theo dõi tiến độ học tập của bạn
            </p>
        </div>
    </div>
</section>

<div class="container-fluid px-4 px-md-5">
    <!-- Statistics Cards -->
    <div class="stats-cards" data-aos="fade-up">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                <i class="fas fa-book-open"></i>
            </div>
            <div class="stats-number">@totalCourses</div>
            <div class="stats-label">Khóa học đã đăng ký</div>
        </div>

        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stats-number" id="completedCourses">0</div>
            <div class="stats-label">Khóa học hoàn thành</div>
        </div>

        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stats-number" id="inProgressCourses">0</div>
            <div class="stats-label">Đang học</div>
        </div>

        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stats-number" id="avgProgress">0%</div>
            <div class="stats-label">Tiến độ trung bình</div>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="overview-cards" data-aos="fade-up">
        <div class="overview-card">
            <div class="overview-number" id="totalLessons">0</div>
            <div class="overview-label">Tổng bài học</div>
        </div>
        <div class="overview-card">
            <div class="overview-number" id="completedLessons">0</div>
            <div class="overview-label">Bài học hoàn thành</div>
        </div>
        <div class="overview-card">
            <div class="overview-number" id="studyHours">0</div>
            <div class="overview-label">Giờ học (ước tính)</div>
        </div>
        <div class="overview-card">
            <div class="overview-number" id="studyStreak">7</div>
            <div class="overview-label">Ngày học liên tiếp</div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs" data-aos="fade-up">
        <ul class="nav nav-pills nav-pills-custom" id="courseFilter">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-filter="all">
                    <i class="fas fa-th-large me-2"></i>Tất cả
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-filter="in-progress">
                    <i class="fas fa-play me-2"></i>Đang học
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-filter="completed">
                    <i class="fas fa-check me-2"></i>Hoàn thành
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-filter="not-started">
                    <i class="fas fa-pause me-2"></i>Chưa bắt đầu
                </a>
            </li>
        </ul>
    </div>

    <!-- Courses Grid -->
    @if (Model != null && Model.Any())
    {
        <div class="row" id="coursesContainer">
            @foreach (var item in Model)
            {
                var course = item.Course;
                var progress = (float)item.Progress;
                var enrollDate = (DateTime)item.EnrollDate;
                var progressStatus = progress >= 100 ? "completed" : (progress > 0 ? "in-progress" : "not-started");
                var statusClass = progress >= 100 ? "status-completed" : (progress > 0 ? "status-in-progress" : "status-not-started");
                var statusText = progress >= 100 ? "Hoàn thành" : (progress > 0 ? "Đang học" : "Chưa bắt đầu");

                <div class="col-lg-6 col-xl-4 mb-4 course-item" data-filter="@progressStatus">
                    <div class="my-course-card" data-aos="fade-up">
                        <div class="course-status-badge @statusClass">
                            @if (progress >= 100)
                            {
                                <i class="fas fa-trophy me-1"></i>
                            }
                            else if (progress > 0)
                            {
                                <i class="fas fa-play me-1"></i>
                            }
                            else
                            {
                                <i class="fas fa-pause me-1"></i>
                            }
                            @statusText
                        </div>

                        <div class="course-header-image">
                            <div class="enrollment-badge">
                                <i class="fas fa-calendar me-1"></i>
                                @enrollDate.ToString("dd/MM/yyyy")
                            </div>
                            <div class="text-center">
                                <i class="fas @(progress >= 100 ? "fa-trophy" : progress > 0 ? "fa-play-circle" : "fa-book") fa-3x mb-2"></i>
                                <div style="font-size: 1rem; font-weight: 600;">
                                    @statusText
                                </div>
                            </div>
                        </div>

                        <div class="course-content">
                            <h3 class="course-title">@course.TenKhoaHoc</h3>

                            <div class="course-teacher">
                                <img src="https://ui-avatars.com/api/?name=@Uri.EscapeDataString(course.User?.HoTen ?? "Teacher")&background=667eea&color=fff&bold=true&size=32"
                                     alt="@course.User?.HoTen" class="teacher-avatar">
                                <span>@(course.User?.HoTen ?? "Chưa có thông tin")</span>
                            </div>

                            <div class="progress-section">
                                <div class="progress-header">
                                    <span class="fw-bold">Tiến độ học tập</span>
                                    <span class="progress-percentage">@progress.ToString("F1")%</span>
                                </div>
                                <div class="progress-bar-custom">
                                    <div class="progress-fill" style="width: @progress%"></div>
                                </div>
                            </div>

                            <div class="course-meta">
                                <div class="enroll-date">
                                    <i class="fas fa-calendar-plus"></i>
                                    <span>@enrollDate.ToString("dd/MM/yyyy")</span>
                                </div>
                                <div class="lesson-count">
                                    <i class="fas fa-play-circle"></i>
                                    <span>@(course.Lessons?.Count ?? 0) bài học</span>
                                </div>
                            </div>

                            <div class="course-actions">
                                @if (progress < 100)
                                {
                                    <a href="@Url.Action("Progress", new { courseId = course.CourseID })"
                                       class="btn-continue">
                                        <i class="fas fa-play me-2"></i>
                                        @(progress > 0 ? "Tiếp tục học" : "Bắt đầu học")
                                    </a>
                                }
                                else
                                {
                                    <a href="@Url.Action("Progress", new { courseId = course.CourseID })"
                                       class="btn-continue">
                                        <i class="fas fa-trophy me-2"></i>Xem lại
                                    </a>
                                }

                                <a href="@Url.Action("Details", new { id = course.CourseID })"
                                   class="btn-details">
                                    <i class="fas fa-info-circle"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <nav class="pagination-enhanced">
                <ul class="pagination mb-0">
                    @if (currentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("MyCourses", new { page = currentPage - 1 })">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    }

                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("MyCourses", new { page = i })">@i</a>
                        </li>
                    }

                    @if (currentPage < totalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("MyCourses", new { page = currentPage + 1 })">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
    else
    {
        <div class="empty-state" data-aos="fade-up">
            <i class="fas fa-graduation-cap"></i>
            <h3>Bạn chưa đăng ký khóa học nào</h3>
            <p class="mb-4">Khám phá hàng ngàn khóa học chất lượng và bắt đầu hành trình học tập của bạn</p>
            <a href="@Url.Action("Index")" class="btn btn-primary btn-lg">
                <i class="fas fa-search me-2"></i>Khám phá khóa học
            </a>
        </div>
    }
</div>

@section Scripts {
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 1000,
            easing: 'ease-out-quart',
            once: true
        });

        $(document).ready(function() {
            // Calculate and update statistics
            updateStatistics();

            // Filter functionality
            $('#courseFilter .nav-link').on('click', function(e) {
                e.preventDefault();

                // Update active state
                $('#courseFilter .nav-link').removeClass('active');
                $(this).addClass('active');

                // Filter courses
                const filter = $(this).data('filter');
                filterCourses(filter);
            });

            // Load average progress
            loadAverageProgress();

            // Calculate overview metrics
            calculateOverviewMetrics();
        });

        function updateStatistics() {
            const courses = $('.course-item');
            const completed = courses.filter('[data-filter="completed"]').length;
            const inProgress = courses.filter('[data-filter="in-progress"]').length;

            $('#completedCourses').text(completed);
            $('#inProgressCourses').text(inProgress);

            // Animate numbers
            animateNumber($('#completedCourses'), completed);
            animateNumber($('#inProgressCourses'), inProgress);
        }

        function animateNumber(element, target) {
            let current = 0;
            const increment = target / 30;
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                element.text(Math.floor(current));
            }, 50);
        }

        function filterCourses(filter) {
            const courses = $('.course-item');

            if (filter === 'all') {
                courses.show();
            } else {
                courses.hide();
                courses.filter('[data-filter="' + filter + '"]').show();
            }

            // Re-trigger AOS for visible items
            AOS.refresh();
        }

        function loadAverageProgress() {
            $.get('@Url.Action("GetAverageProgress")')
                .done(function(avgProgress) {
                    $('#avgProgress').text(avgProgress + '%');
                    animateNumber($('#avgProgress'), avgProgress);
                })
                .fail(function() {
                    $('#avgProgress').text('N/A');
                });
        }

        function calculateOverviewMetrics() {
            let totalLessons = 0;
            let completedLessons = 0;
            let studyHours = 0;

        @if (Model != null && Model.Any())
        {
            <text>
                @foreach (var item in Model)
                {
                    <text>
                            totalLessons += @(item.Course.Lessons?.Count ?? 0);
                            completedLessons += Math.floor((@item.Progress / 100) * @(item.Course.Lessons?.Count ?? 0));
                            studyHours += Math.floor((@item.Progress / 100) * @(item.Course.Lessons?.Count ?? 0) * 0.5); // Assume 30 min per lesson
                    </text>
                }
            </text>
        }

            // Animate overview numbers
            animateNumber($('#totalLessons'), totalLessons);
            animateNumber($('#completedLessons'), completedLessons);
            animateNumber($('#studyHours'), studyHours);
        }

        // Configure toastr
        if (typeof toastr !== 'undefined') {
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "timeOut": 3000
            };
        }
    </script>
}