@model List<DACSN10.Models.Course>
@{
    ViewData["Title"] = "Khóa học của tôi";
}

<div class="container animate__animated animate__fadeIn">
    <h1 class="mb-4 text-center fw-bold">
        <i class="fas fa-book me-2 text-primary"></i> Khóa học của tôi
    </h1>

    @if (!User.Identity.IsAuthenticated)
    {
        <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle me-2"></i> Vui lòng <a href="/Identity/Account/Login">đăng nhập</a> để xem khóa học của bạn.
        </div>
    }
    else
    {
        <ul class="nav nav-tabs mb-4" id="myCoursesTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="true">
                    <i class="fas fa-th-list me-1"></i> Tất cả
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inprogress-tab" data-bs-toggle="tab" data-bs-target="#inprogress" type="button" role="tab" aria-controls="inprogress" aria-selected="false">
                    <i class="fas fa-spinner me-1"></i> Đang học
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab" aria-controls="completed" aria-selected="false">
                    <i class="fas fa-check-circle me-1"></i> Đã hoàn thành
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myCoursesTabContent">
            <!-- Tab tất cả khóa học -->
            <div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tab">
                @if (Model != null && Model.Any())
                {
                    <div class="row row-cols-1 row-cols-md-3 g-4">
                        @foreach (var course in Model)
                        {
                            var enrollment = course.Enrollments?.FirstOrDefault(e => e.UserID == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value);
                            var progress = enrollment?.Progress ?? 0;

                            <div class="col course-item">
                                <div class="card h-100 shadow-sm course-card">
                                    <div class="position-relative">
                                        <div class="position-absolute top-0 end-0 m-2">
                                            @if (progress == 100)
                                            {
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check-circle me-1"></i> Hoàn thành
                                                </span>
                                            }
                                            else if (progress > 0)
                                            {
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-spinner me-1"></i> Đang học
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-exclamation-circle me-1"></i> Chưa bắt đầu
                                                </span>
                                            }
                                        </div>
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">@course.TenKhoaHoc</h5>
                                        <p class="card-text text-muted small">
                                            <i class="fas fa-user me-1"></i> @(course.User?.HoTen ?? "Không có thông tin")
                                        </p>
                                        <div class="progress mt-2 mb-2">
                                            <div class="progress-bar" role="progressbar" style="width: @progress%;" aria-valuenow="@progress" aria-valuemin="0" aria-valuemax="100">@progress%</div>
                                        </div>
                                        <p class="card-text" style="height: 50px; overflow: hidden;">
                                            @(course.MoTa?.Length > 100 ? course.MoTa.Substring(0, 100) + "..." : course.MoTa)
                                        </p>
                                        <div class="mt-auto d-flex justify-content-between align-items-center">
                                            <a href="@Url.Action("Details", new { id = course.CourseID })" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-info-circle me-1"></i> Chi tiết
                                            </a>
                                            <div>
                                                <a href="@Url.Action("Progress", new { courseId = course.CourseID })" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-play-circle me-1"></i> Tiếp tục học
                                                </a>
                                            </div>
                                        </div>
                                        <div class="mt-2 small text-muted text-center">
                                            @if (enrollment != null)
                                            {
                                                <span>Đăng ký: @enrollment.EnrollDate.ToString("dd/MM/yyyy")</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <img src="/images/empty-courses.svg" alt="Không có khóa học" style="max-width: 200px;" class="mb-4">
                        <h3>Bạn chưa đăng ký khóa học nào</h3>
                        <p class="text-muted">Khám phá và đăng ký các khóa học để bắt đầu hành trình học tập của bạn</p>
                        <a href="@Url.Action("Index", "Course")" class="btn btn-primary mt-3">
                            <i class="fas fa-search me-1"></i> Tìm khóa học
                        </a>
                    </div>
                }
            </div>

            <!-- Tab khóa học đang học -->
            <div class="tab-pane fade" id="inprogress" role="tabpanel" aria-labelledby="inprogress-tab">
                <div id="inprogressCourses" class="row row-cols-1 row-cols-md-3 g-4">
                    <!-- Nội dung sẽ được thêm bằng JavaScript -->
                </div>
            </div>

            <!-- Tab khóa học đã hoàn thành -->
            <div class="tab-pane fade" id="completed" role="tabpanel" aria-labelledby="completed-tab">
                <div id="completedCourses" class="row row-cols-1 row-cols-md-3 g-4">
                    <!-- Nội dung sẽ được thêm bằng JavaScript -->
                </div>
            </div>
        </div>

        <!-- Thống kê tiến độ học tập -->
        <div class="card shadow-sm mt-5">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Thống kê học tập</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-7">
                        <canvas id="progressChart"></canvas>
                    </div>
                    <div class="col-md-5">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="mb-0">Tổng số khóa học</h6>
                                    <small class="text-muted">Số khóa học đã đăng ký</small>
                                </div>
                                <span class="badge bg-primary rounded-pill fs-5">@(Model?.Count ?? 0)</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="mb-0">Đang học</h6>
                                    <small class="text-muted">Số khóa học đang tiến hành</small>
                                </div>
                                <span id="inprogressCount" class="badge bg-warning rounded-pill fs-5">0</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="mb-0">Hoàn thành</h6>
                                    <small class="text-muted">Số khóa học đã hoàn thành</small>
                                </div>
                                <span id="completedCount" class="badge bg-success rounded-pill fs-5">0</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="mb-0">Chưa bắt đầu</h6>
                                    <small class="text-muted">Số khóa học chưa học</small>
                                </div>
                                <span id="notStartedCount" class="badge bg-secondary rounded-pill fs-5">0</span>
                            </div>

                            <div class="mt-4">
                                <a href="@Url.Action("GetAverageProgress", "Course")" id="refreshProgress" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-sync-alt me-1"></i> Cập nhật tiến độ
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
        @if (User.Identity.IsAuthenticated && Model != null && Model.Any())
        {
            <text>
                    // Lọc và hiển thị khóa học theo trạng thái
                    var inprogressCourses = [];
                    var completedCourses = [];
                    var notStartedCourses = [];

                @foreach (var course in Model)
                {
                    var enrollment = course.Enrollments?.FirstOrDefault(e => e.UserID == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value);
                    var progress = enrollment?.Progress ?? 0;

                    <text>
                            var course = {
                                id: @course.CourseID,
                                title: '@Html.Raw(Json.Serialize(course.TenKhoaHoc))',
                                instructor: '@(course.User?.HoTen ?? "Không có thông tin")',
                                progress: @progress,
                                                                description: '@Html.Raw(Json.Serialize(course.MoTa?.Length > 100 ? course.MoTa.Substring(0, 100) + "..." : course.MoTa))',
                                        enrollDate: '@(enrollment?.EnrollDate.ToString("dd/MM/yyyy") ?? DateTime.Now.ToString("dd/MM/yyyy"))'
                                    };

                                    if (@progress === 100) {
                                        completedCourses.push(course);
                                    } else if (@progress > 0) {
                                        inprogressCourses.push(course);
                                    } else {
                                        notStartedCourses.push(course);
                                    }
                    </text>
                }

                        // Cập nhật số lượng
                        $("#inprogressCount").text(inprogressCourses.length);
                        $("#completedCount").text(completedCourses.length);
                        $("#notStartedCount").text(notStartedCourses.length);

                        // Hiển thị khóa học đang học
                        var inprogressHtml = '';
                        if (inprogressCourses.length > 0) {
                            inprogressCourses.forEach(function(course) {
                                inprogressHtml += `
                                    <div class="col course-item">
                                        <div class="card h-100 shadow-sm course-card">
                                            <div class="position-relative">
                                                <img src="${course.image}" class="card-img-top" alt="${course.title}" style="height: 180px; object-fit: cover;">
                                                <div class="position-absolute top-0 end-0 m-2">
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-spinner me-1"></i> Đang học
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="card-body d-flex flex-column">
                                                <h5 class="card-title">${course.title}</h5>
                                                <p class="card-text text-muted small">
                                                    <i class="fas fa-user me-1"></i> ${course.instructor}
                                                </p>
                                                <div class="progress mt-2 mb-2">
                                                    <div class="progress-bar" role="progressbar" style="width: ${course.progress}%;" aria-valuenow="${course.progress}" aria-valuemin="0" aria-valuemax="100">${course.progress}%</div>
                                                </div>
                                                <p class="card-text" style="height: 50px; overflow: hidden;">${course.description}</p>
                                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                                    <a href="/Course/Details/${course.id}" class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-info-circle me-1"></i> Chi tiết
                                                    </a>
                                                    <div>
                                                        <a href="/Course/Progress/${course.id}" class="btn btn-primary btn-sm">
                                                            <i class="fas fa-play-circle me-1"></i> Tiếp tục học
                                                        </a>
                                                    </div>
                                                </div>
                                                <div class="mt-2 small text-muted text-center">
                                                    <span>Đăng ký: ${course.enrollDate}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            inprogressHtml = `
                                <div class="col-12">
                                    <div class="alert alert-info text-center">
                                        <i class="fas fa-info-circle me-2"></i> Bạn chưa có khóa học nào đang học
                                    </div>
                                </div>
                            `;
                        }
                        $("#inprogressCourses").html(inprogressHtml);

                        // Hiển thị khóa học đã hoàn thành
                        var completedHtml = '';
                        if (completedCourses.length > 0) {
                            completedCourses.forEach(function(course) {
                                completedHtml += `
                                    <div class="col course-item">
                                        <div class="card h-100 shadow-sm course-card">
                                            <div class="position-relative">
                                                <img src="${course.image}" class="card-img-top" alt="${course.title}" style="height: 180px; object-fit: cover;">
                                                <div class="position-absolute top-0 end-0 m-2">
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check-circle me-1"></i> Hoàn thành
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="card-body d-flex flex-column">
                                                <h5 class="card-title">${course.title}</h5>
                                                <p class="card-text text-muted small">
                                                    <i class="fas fa-user me-1"></i> ${course.instructor}
                                                </p>
                                                <div class="progress mt-2 mb-2">
                                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
                                                </div>
                                                <p class="card-text" style="height: 50px; overflow: hidden;">${course.description}</p>
                                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                                    <a href="/Course/Details/${course.id}" class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-info-circle me-1"></i> Chi tiết
                                                    </a>
                                                    <a href="#" class="btn btn-success btn-sm get-certificate" data-id="${course.id}">
                                                        <i class="fas fa-certificate me-1"></i> Chứng chỉ
                                                    </a>
                                                </div>
                                                <div class="mt-2 small text-muted text-center">
                                                    <span>Hoàn thành: ${course.enrollDate}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            completedHtml = `
                                <div class="col-12">
                                    <div class="alert alert-info text-center">
                                        <i class="fas fa-info-circle me-2"></i> Bạn chưa hoàn thành khóa học nào
                                    </div>
                                </div>
                            `;
                        }
                        $("#completedCourses").html(completedHtml);

                        // Vẽ biểu đồ thống kê
                        var ctx = document.getElementById('progressChart').getContext('2d');
                        var progressChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Hoàn thành', 'Đang học', 'Chưa bắt đầu'],
                                datasets: [{
                                    data: [completedCourses.length, inprogressCourses.length, notStartedCourses.length],
                                    backgroundColor: [
                                        'rgba(40, 167, 69, 0.7)',
                                        'rgba(0, 123, 255, 0.7)',
                                        'rgba(108, 117, 125, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(40, 167, 69, 1)',
                                        'rgba(0, 123, 255, 1)',
                                        'rgba(108, 117, 125, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Tiến độ học tập của bạn'
                                    }
                                },
                                animation: {
                                    animateScale: true,
                                    animateRotate: true
                                }
                            }
                        });

                        // Xử lý nút lấy chứng chỉ
                        $(document).on('click', '.get-certificate', function(e) {
                            e.preventDefault();
                            var courseId = $(this).data('id');

                            Swal.fire({
                                title: 'Chứng chỉ khóa học',
                                html: 'Chúc mừng bạn đã hoàn thành khóa học!<br>Bạn có thể tải chứng chỉ của mình.',
                                icon: 'success',
                                showCancelButton: true,
                                confirmButtonText: 'Tải chứng chỉ',
                                cancelButtonText: 'Đóng'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    toastr.success('Đang chuẩn bị chứng chỉ của bạn...');
                                    setTimeout(function() {
                                        toastr.info('Chức năng này đang được phát triển. Vui lòng thử lại sau!');
                                    }, 2000);
                                }
                            });
                        });

                        // Xử lý nút cập nhật tiến độ
                        $("#refreshProgress").click(function(e) {
                            e.preventDefault();

                            $(this).html('<i class="fas fa-spinner fa-spin me-1"></i> Đang cập nhật...');

                            $.ajax({
                                url: $(this).attr('href'),
                                type: 'GET',
                                success: function(data) {
                                    toastr.success('Cập nhật tiến độ thành công!');
                                    setTimeout(function() {
                                        location.reload();
                                    }, 1000);
                                },
                                error: function() {
                                    toastr.error('Có lỗi xảy ra khi cập nhật tiến độ.');
                                    $("#refreshProgress").html('<i class="fas fa-sync-alt me-1"></i> Cập nhật tiến độ');
                                }
                            });
                        });
            </text>
        }

            // Animation cho các thẻ
            $('.card').hover(
                function() {
                    $(this).addClass('shadow');
                    $(this).css('transform', 'translateY(-5px)');
                },
                function() {
                    $(this).removeClass('shadow');
                    $(this).css('transform', 'translateY(0)');
                }
            );

            // Hiệu ứng cuộn trang
            $(window).scroll(function() {
                $(".course-card").each(function() {
                    var position = $(this).offset().top;
                    var scrollPosition = $(window).scrollTop() + $(window).height();

                    if (scrollPosition > position) {
                        $(this).addClass("animate__animated animate__fadeIn");
                    }
                });
            });
        });
    </script>
}