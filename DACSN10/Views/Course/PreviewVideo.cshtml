@model DACSN10.Models.Lesson
@{
    ViewData["Title"] = $"Xem trước - {Model.Course.TenKhoaHoc} - OnlineLearning";
}

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
    <link href="~/css/PreviewVideo.css" rel="stylesheet" />
}

<!-- Preview Header -->
<section class="preview-header">
    <div class="container-fluid px-4 px-md-5">
        <div class="preview-content" data-aos="fade-up">
            <div class="preview-badge">
                <i class="fas fa-eye me-2"></i>Xem trước miễn phí
            </div>

            <h1 class="h3 fw-bold mb-2">@Model.TenBaiHoc</h1>
            <p class="mb-0 opacity-90">
                Khóa học: @Model.Course.TenKhoaHoc
            </p>
        </div>
    </div>
</section>

<div class="container-fluid px-4 px-md-5">
    <!-- Video Container -->
    <div class="video-container" data-aos="fade-up">
        <div class="video-player" onclick="playPreview()">
            <div class="play-button">
                <i class="fas fa-play"></i>
            </div>

            <div class="video-placeholder">
                <h4 class="mb-2">Bài học xem trước</h4>
                <p class="mb-0">Click để xem video giới thiệu</p>
            </div>
        </div>

        <div class="video-info">
            <div class="video-details">
                <h3>@Model.TenBaiHoc</h3>

                <div class="video-meta">
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>@Model.ThoiLuong phút</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-eye"></i>
                        <span>Xem trước miễn phí</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-video"></i>
                        <span>Chất lượng HD</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-closed-captioning"></i>
                        <span>Phụ đề tiếng Việt</span>
                    </div>
                </div>

                <div class="video-description">
                    <p>@(string.IsNullOrEmpty(Model.NoiDung) ? "Đây là bài học mở đầu của khóa học, giúp bạn hiểu tổng quan về nội dung và phương pháp học tập. Bạn sẽ được làm quen với giảng viên và cách thức tổ chức bài học trong suốt khóa học." : Model.NoiDung)</p>
                </div>

                <!-- Warning Banner -->
                <div class="warning-banner">
                    <div class="warning-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h5 class="fw-bold text-warning mb-2">Chỉ là bài học xem trước</h5>
                    <p class="mb-0">Để truy cập đầy đủ nội dung khóa học và các tính năng khác, vui lòng đăng ký khóa học.</p>
                </div>

                <div class="preview-actions">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <a href="@Url.Action("Details", new { id = Model.CourseID })" class="btn-enroll-preview">
                            <i class="fas fa-graduation-cap"></i>
                            Đăng ký khóa học
                        </a>
                    }
                    else
                    {
                        <a href="/Identity/Account/Login" class="btn-enroll-preview">
                            <i class="fas fa-sign-in-alt"></i>
                            Đăng nhập để học
                        </a>
                    }

                    <a href="@Url.Action("Details", new { id = Model.CourseID })" class="btn-back-preview">
                        <i class="fas fa-arrow-left"></i>
                        Quay lại khóa học
                    </a>
                </div>
            </div>

            <!-- Course Preview Card -->
            <div class="course-preview-card">
                <h4 class="course-title-preview">@Model.Course.TenKhoaHoc</h4>

                <div class="course-teacher-preview">
                    <img src="https://ui-avatars.com/api/?name=@Uri.EscapeDataString(Model.Course.User?.HoTen ?? "Teacher")&background=667eea&color=fff&bold=true&size=40"
                         alt="@Model.Course.User?.HoTen" class="teacher-avatar-preview">
                    <div>
                        <div class="fw-bold">@(Model.Course.User?.HoTen ?? "Chưa có thông tin")</div>
                        <small class="text-muted">Giảng viên</small>
                    </div>
                </div>

                <div class="course-stats-preview">
                    <div class="stat-preview">
                        <div class="stat-number-preview">@(Model.Course.Enrollments?.Count ?? 0)</div>
                        <div class="stat-label-preview">Học viên</div>
                    </div>
                    <div class="stat-preview">
                        <div class="stat-number-preview">@(Model.Course.Lessons?.Count ?? 0)</div>
                        <div class="stat-label-preview">Bài học</div>
                    </div>
                    <div class="stat-preview">
                        <div class="stat-number-preview">@(Model.Course.Quizzes?.Count ?? 0)</div>
                        <div class="stat-label-preview">Kiểm tra</div>
                    </div>
                    <div class="stat-preview">
                        <div class="stat-number-preview">4.8</div>
                        <div class="stat-label-preview">Đánh giá</div>
                    </div>
                </div>

                <div class="price-preview">
                    @if (Model.Course.Gia > 0)
                    {
                        <div class="price-amount-preview">@Model.Course.Gia.ToString("N0")₫</div>
                    }
                    else
                    {
                        <div class="price-amount-preview">Miễn phí</div>
                    }
                </div>

                <ul class="preview-features">
                    <li>
                        <i class="fas fa-infinity"></i>
                        <span>Truy cập trọn đời</span>
                    </li>
                    <li>
                        <i class="fas fa-mobile-alt"></i>
                        <span>Học trên mọi thiết bị</span>
                    </li>
                    <li>
                        <i class="fas fa-certificate"></i>
                        <span>Chứng chỉ hoàn thành</span>
                    </li>
                    <li>
                        <i class="fas fa-comments"></i>
                        <span>Hỗ trợ trực tuyến</span>
                    </li>
                    <li>
                        <i class="fas fa-download"></i>
                        <span>Tài liệu tải về</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Related Lessons -->
    @if (Model.Course.Lessons != null && Model.Course.Lessons.Count > 1)
    {
        <div class="related-lessons" data-aos="fade-up">
            <h5 class="fw-bold mb-3">Các bài học trong khóa học</h5>
            <p class="text-muted mb-4">Khám phá toàn bộ nội dung khóa học (@Model.Course.Lessons.Count bài học)</p>

            @foreach (var lesson in Model.Course.Lessons.OrderBy(l => l.LessonID).Take(5))
            {
                <div class="lesson-preview-item">
                    <div class="lesson-number-preview">@(Model.Course.Lessons.OrderBy(l => l.LessonID).ToList().IndexOf(lesson) + 1)</div>
                    <div class="lesson-content-preview">
                        <div class="lesson-title-preview">@lesson.TenBaiHoc</div>
                        <div class="lesson-duration-preview">
                            <i class="fas fa-clock me-1"></i>@lesson.ThoiLuong phút
                        </div>
                    </div>
                    @if (lesson.LessonID == Model.LessonID)
                    {
                        <span class="badge bg-success">Đang xem</span>
                    }
                    else
                    {
                        <i class="fas fa-lock lesson-lock"></i>
                    }
                </div>
            }

            @if (Model.Course.Lessons.Count > 5)
            {
                <div class="text-center mt-3">
                    <a href="@Url.Action("Details", new { id = Model.CourseID })" class="btn btn-outline-primary">
                        Xem tất cả @Model.Course.Lessons.Count bài học
                    </a>
                </div>
            }
        </div>
    }
</div>

<!-- Fullscreen Video Overlay -->
<div class="fullscreen-overlay" id="fullscreenOverlay">
    <div class="fullscreen-player">
        <button class="close-fullscreen" onclick="closeFullscreen()">
            <i class="fas fa-times"></i>
        </button>
        <div class="d-flex align-items-center justify-content-center h-100 text-white">
            <div class="text-center">
                <i class="fas fa-play-circle fa-5x mb-3"></i>
                <h4>Video Preview</h4>
                <p>Đây sẽ là nơi phát video xem trước thực tế</p>
                <button class="btn btn-primary btn-lg" onclick="closeFullscreen()">
                    <i class="fas fa-times me-2"></i>Đóng
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 1000,
            easing: 'ease-out-quart',
            once: true
        });

        function playPreview() {
            // Show fullscreen overlay
            document.getElementById('fullscreenOverlay').style.display = 'flex';

            // In a real implementation, you would:
            // 1. Load the actual video URL from @Model.VideoUrl
            // 2. Initialize a video player (like Video.js, Plyr, etc.)
            // 3. Handle play/pause/seek functionality

            console.log('Playing preview for lesson:', @Model.LessonID);

            // Simulate video loading
            setTimeout(() => {
                toastr.info('Video xem trước đang được tải...');
            }, 500);
        }

        function closeFullscreen() {
            document.getElementById('fullscreenOverlay').style.display = 'none';
        }

        // Close fullscreen on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFullscreen();
            }
        });

        // Close fullscreen when clicking outside the player
        document.getElementById('fullscreenOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFullscreen();
            }
        });

        // Configure toastr
        if (typeof toastr !== 'undefined') {
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "timeOut": 3000
            };
        }

        // Track preview viewing for analytics
        $(document).ready(function() {
            // Log preview view
            console.log('Preview started for course:', @Model.CourseID, 'lesson:', @Model.LessonID);

            // You could send analytics data here
            // analytics.track('preview_viewed', {
            //     course_id: @Model.CourseID,
            //     lesson_id: @Model.LessonID,
            //     course_name: '@Model.Course.TenKhoaHoc',
            //     lesson_name: '@Model.TenBaiHoc'
            // });
        });
    </script>
}