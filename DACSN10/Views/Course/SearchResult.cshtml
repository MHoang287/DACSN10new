@model List<DACSN10.Models.Course>
@{
    ViewData["Title"] = "Kết quả tìm kiếm";
}

<div class="container animate__animated animate__fadeIn">
    <h1 class="mb-2 text-center fw-bold">Kết quả tìm kiếm</h1>

    <div class="text-center mb-4">
        @if (!string.IsNullOrEmpty(ViewBag.Keyword))
        {
            <p class="lead">Kết quả tìm kiếm cho từ khóa: <span class="fw-bold text-primary">@ViewBag.Keyword</span></p>
        }
        else if (!string.IsNullOrEmpty(ViewBag.Topic))
        {
            <p class="lead">Kết quả tìm kiếm cho chủ đề: <span class="fw-bold text-primary">@ViewBag.Topic</span></p>
        }
        else if (ViewBag.CategoryId > 0)
        {
            <p class="lead">Kết quả tìm kiếm cho danh mục: <span class="fw-bold text-primary" id="categoryName">Đang tải...</span></p>
        }
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger text-center">
            <i class="fas fa-exclamation-triangle me-2"></i> @TempData["Error"]
        </div>
    }

    <div class="row mb-4">
        <div class="col-md-9">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchInResults" class="form-control" placeholder="Tìm kiếm trong kết quả...">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-filter me-1"></i> Lọc
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item sort-option" href="#" data-sort="name-asc"><i class="fas fa-sort-alpha-down me-2"></i> Tên (A-Z)</a></li>
                            <li><a class="dropdown-item sort-option" href="#" data-sort="name-desc"><i class="fas fa-sort-alpha-up me-2"></i> Tên (Z-A)</a></li>
                            <li><a class="dropdown-item sort-option" href="#" data-sort="date-desc"><i class="fas fa-calendar-alt me-2"></i> Mới nhất</a></li>
                            <li><a class="dropdown-item sort-option" href="#" data-sort="date-asc"><i class="fas fa-calendar-alt me-2"></i> Cũ nhất</a></li>
                            <li><a class="dropdown-item sort-option" href="#" data-sort="popularity"><i class="fas fa-fire me-2"></i> Phổ biến nhất</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="d-flex justify-content-between align-items-center bg-light rounded p-3 h-100">
                <div>Tìm thấy:</div>
                <span class="badge bg-primary rounded-pill fs-6" id="resultCount">@Model.Count</span>
            </div>
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="row row-cols-1 row-cols-md-3 g-4" id="searchResults">
            @foreach (var course in Model)
            {
                <div class="col course-item"
                     data-name="@course.TenKhoaHoc.ToLower()"
                     data-date="@course.NgayTao.ToString("yyyyMMdd")"
                     data-popularity="@(course.Enrollments?.Count ?? 0)">
                    <div class="card h-100 shadow-sm course-card">
                        <div class="position-relative">
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-primary rounded-pill">
                                    <i class="fas fa-users me-1"></i> @(course.Enrollments?.Count ?? 0)
                                </span>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@course.TenKhoaHoc</h5>
                            <p class="card-text text-muted small">
                                <i class="fas fa-user me-1"></i> @(course.User?.HoTen ?? "Không có thông tin")
                            </p>
                            <p class="card-text text-muted small">
                                <i class="fas fa-calendar-alt me-1"></i> @course.NgayTao.ToString("dd/MM/yyyy")
                            </p>
                            <p class="card-text" style="height: 50px; overflow: hidden;">
                                @(course.MoTa?.Length > 100 ? course.MoTa.Substring(0, 100) + "..." : course.MoTa)
                            </p>
                            <div class="mt-auto d-flex justify-content-between">
                                <a href="@Url.Action("Details", new { id = course.CourseID })" class="btn btn-primary">
                                    <i class="fas fa-info-circle me-1"></i> Chi tiết
                                </a>
                                @if (User.Identity.IsAuthenticated)
                                {
                                    <form asp-action="Enroll" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="courseId" value="@course.CourseID" />
                                        <button type="submit" class="btn btn-outline-primary">
                                            <i class="fas fa-graduation-cap me-1"></i> Đăng ký
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <a href="/Identity/Account/Login" class="btn btn-outline-primary">
                                        <i class="fas fa-sign-in-alt me-1"></i> Đăng nhập để đăng ký
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Biểu đồ phân phối -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Phân phối kết quả tìm kiếm</h5>
            </div>
            <div class="card-body">
                <canvas id="resultsChart" height="200"></canvas>
            </div>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <img src="/images/no-results.svg" alt="Không có kết quả" style="max-width: 200px;" class="mb-4">
            <h3>Không tìm thấy kết quả phù hợp</h3>
            <p class="text-muted">Vui lòng thử lại với từ khóa khác hoặc khám phá các khóa học của chúng tôi</p>
            <div class="mt-4">
                <a href="@Url.Action("Index", "Course")" class="btn btn-primary me-2">
                    <i class="fas fa-th-list me-1"></i> Tất cả khóa học
                </a>
                <a href="@Url.Action("PopularCourses", "Course")" class="btn btn-outline-primary">
                    <i class="fas fa-fire me-1"></i> Khóa học phổ biến
                </a>
            </div>
        </div>
    }

    <!-- Đề xuất khóa học liên quan -->
    @if (Model != null && Model.Any())
    {
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2 text-warning"></i> Có thể bạn quan tâm</h5>
            </div>
            <div class="card-body">
                <div class="row" id="suggestedCourses">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2">Đang tải khóa học đề xuất...</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Lấy tên danh mục nếu tìm kiếm theo danh mục
        @if (ViewBag.CategoryId > 0)
        {
            <text>
                        $.ajax({
                            url: '/api/categories/@ViewBag.CategoryId', // Đây là API giả định
                            type: 'GET',
                            success: function(data) {
                                $('#categoryName').text(data.name || 'Danh mục');
                            },
                            error: function() {
                                $('#categoryName').text('Danh mục');
                            }
                        });
            </text>
        }

            // Tìm kiếm trong kết quả
            $("#searchInResults").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $(".course-item").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });

                // Cập nhật số lượng kết quả hiển thị
                $('#resultCount').text($('.course-item:visible').length);
            });

            // Sắp xếp kết quả
            $(".sort-option").on("click", function(e) {
                e.preventDefault();
                var sortBy = $(this).data('sort');
                var items = $('#searchResults .course-item').get();

                items.sort(function(a, b) {
                    switch(sortBy) {
                        case 'name-asc':
                            return $(a).data('name').localeCompare($(b).data('name'));
                        case 'name-desc':
                            return $(b).data('name').localeCompare($(a).data('name'));
                        case 'date-desc':
                            return $(b).data('date') - $(a).data('date');
                        case 'date-asc':
                            return $(a).data('date') - $(b).data('date');
                        case 'popularity':
                            return $(b).data('popularity') - $(a).data('popularity');
                        default:
                            return 0;
                    }
                });

                $.each(items, function(i, item) {
                    $('#searchResults').append(item);
                });

                toastr.success('Đã sắp xếp kết quả!');
            });

            // Vẽ biểu đồ phân phối
        @if (Model != null && Model.Any())
        {
            <text>
                        var ctx = document.getElementById('resultsChart').getContext('2d');

                        // Nhóm các khóa học theo ngày tạo (tháng)
                        var coursesByMonth = {};
                        var monthLabels = [];

                @foreach (var course in Model)
                {
                    <text>
                                    var month = '@course.NgayTao.ToString("MM/yyyy")';
                                    if (!coursesByMonth[month]) {
                                        coursesByMonth[month] = 0;
                                        monthLabels.push(month);
                                    }
                                    coursesByMonth[month]++;
                    </text>
                }

                        // Sắp xếp tháng
                        monthLabels.sort(function(a, b) {
                            var partsA = a.split('/');
                            var partsB = b.split('/');
                            var dateA = new Date(partsA[1], partsA[0]-1);
                            var dateB = new Date(partsB[1], partsB[0]-1);
                            return dateA - dateB;
                        });

                        var chartData = monthLabels.map(function(month) {
                            return coursesByMonth[month];
                        });

                        var resultsChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: monthLabels,
                                datasets: [{
                                    label: 'Số lượng khóa học',
                                    data: chartData,
                                    backgroundColor: 'rgba(13, 110, 253, 0.7)',
                                    borderColor: 'rgba(13, 110, 253, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Phân phối khóa học theo tháng tạo'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                var label = context.dataset.label || '';
                                                label += ': ' + context.parsed.y;
                                                return label;
                                            }
                                        }
                                    }
                                }
                            }
                        });
            </text>
        }

            // Lấy khóa học đề xuất
        @if (Model != null && Model.Any())
        {
            <text>
                        $.ajax({
                            url: '@Url.Action("PopularCourses", "Course")',
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                var suggestedCoursesHtml = '';
                                var existingCourseIds = [@string.Join(",", Model.Select(c => c.CourseID))];
                                var suggestedCourses = (data || []).filter(function(course) {
                                    return !existingCourseIds.includes(course.CourseID);
                                }).slice(0, 4);

                                if (suggestedCourses.length > 0) {
                                    suggestedCoursesHtml = '<div class="row row-cols-1 row-cols-md-4 g-4">';
                                    suggestedCourses.forEach(function(course) {
                                        suggestedCoursesHtml += `
                                            <div class="col">
                                                <div class="card h-100 shadow-sm">
                                                    <img src="${course.HinhAnh || '/images/default-course.jpg'}" class="card-img-top" alt="${course.TenKhoaHoc}" style="height: 120px; object-fit: cover;">
                                                    <div class="card-body">
                                                        <h6 class="card-title">${course.TenKhoaHoc}</h6>
                                                        <p class="card-text text-muted small">
                                                            <i class="fas fa-user me-1"></i> ${course.User?.HoTen || 'Không có thông tin'}
                                                        </p>
                                                        <a href="/Course/Details/${course.CourseID}" class="btn btn-sm btn-primary w-100">
                                                            <i class="fas fa-info-circle me-1"></i> Xem chi tiết
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    suggestedCoursesHtml += '</div>';
                                } else {
                                    suggestedCoursesHtml = '<div class="alert alert-info text-center">Không có khóa học đề xuất nào.</div>';
                                }

                                $('#suggestedCourses').html(suggestedCoursesHtml);
                            },
                            error: function() {
                                $('#suggestedCourses').html('<div class="alert alert-warning text-center">Không thể tải khóa học đề xuất.</div>');
                            }
                        });
            </text>
        }

            // Animation cho các thẻ
            $('.course-card').hover(
                function() {
                    $(this).addClass('animate__animated animate__pulse');
                },
                function() {
                    $(this).removeClass('animate__animated animate__pulse');
                }
            );
        });
    </script>
}