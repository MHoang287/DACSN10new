@model List<DACSN10.Models.Course>
@{
    ViewData["Title"] = "Kết quả tìm kiếm - OnlineLearning";
    var keyword = ViewBag.Keyword ?? "";
    var topic = ViewBag.Topic ?? "";
    var categoryName = ViewBag.CategoryName ?? "";
    var searchType = ViewBag.SearchType ?? "";
    var totalResults = ViewBag.TotalResults ?? 0;
    var totalPages = ViewBag.TotalPages ?? 1;
    var currentPage = ViewBag.Page ?? 1;

    string searchTitle = searchType switch
    {
        "name" => $"Tìm kiếm: \"{keyword}\"",
        "topic" => $"Chủ đề: \"{topic}\"",
        "category" => $"Danh mục: {categoryName}",
        _ => "Kết quả tìm kiếm"
    };
}

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
    <link href="~/css/SearchResult.css" rel="stylesheet" />
}

<!-- Search Header -->
<section class="search-header">
    <div class="container-fluid px-4 px-md-5">
        <div class="search-content" data-aos="fade-up">
            <!-- Breadcrumb -->
            <div class="breadcrumb-search">
                <a href="@Url.Action("Index", "Home")">Trang chủ</a> /
                <a href="@Url.Action("Index", "Course")">Khóa học</a> /
                <span>Tìm kiếm</span>
            </div>

            <h1 class="display-5 fw-bold mb-3">@searchTitle</h1>
            <p class="fs-5 mb-0 opacity-90">
                @if (totalResults > 0)
                {
                    <span>Tìm thấy @totalResults khóa học phù hợp</span>
                }
                else
                {
                    <span>Không tìm thấy kết quả phù hợp</span>
                }
            </p>
        </div>
    </div>
</section>

<div class="container-fluid px-4 px-md-5">
    <!-- Search Results Info -->
    <div class="search-results-info" data-aos="fade-up">
        <div class="results-summary">
            <div class="results-count">
                Hiển thị <strong>@Model.Count</strong> trong tổng số <strong>@totalResults</strong> kết quả
            </div>

            <div class="search-filters">
                <select class="filter-select" id="sortFilter" onchange="applySortFilter()">
                    <option value="relevance">Liên quan nhất</option>
                    <option value="popular">Phổ biến nhất</option>
                    <option value="newest">Mới nhất</option>
                    <option value="price-low">Giá thấp đến cao</option>
                    <option value="price-high">Giá cao đến thấp</option>
                </select>

                <select class="filter-select" id="priceFilter" onchange="applyPriceFilter()">
                    <option value="all">Tất cả giá</option>
                    <option value="free">Miễn phí</option>
                    <option value="paid">Có phí</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Search Results Grid -->
    @if (Model != null && Model.Any())
    {
        <div class="search-grid" id="searchResults">
            @foreach (var course in Model)
            {
                <div class="search-course-card course-item"
                     data-aos="fade-up"
                     data-price="@course.Gia"
                     data-enrollments="@(course.Enrollments?.Count ?? 0)"
                     data-created="@course.NgayTao.ToString("yyyy-MM-dd")">

                    <div class="course-image-search">
                        <div class="course-badge-search">
                            @if (course.Gia == 0)
                            {
                                <i class="fas fa-gift me-1">Miễn phí</i>
                            }
                            else
                            {
                                <i class="fas fa-star me-1">Premium</i>
                            }
                        </div>
                        <div class="text-center">
                            <i class="fas fa-graduation-cap fa-3x mb-2"></i>
                            <div style="font-size: 0.9rem; font-weight: 600;">Khóa học</div>
                        </div>
                    </div>

                    <div class="course-content-search">
                        <h3 class="course-title-search">@course.TenKhoaHoc</h3>

                        <div class="course-teacher-search">
                            <img src="https://ui-avatars.com/api/?name=@Uri.EscapeDataString(course.User?.HoTen ?? "Teacher")&background=667eea&color=fff&bold=true&size=32"
                                 alt="@course.User?.HoTen" class="teacher-avatar-search">
                            <span>@(course.User?.HoTen ?? "Chưa có thông tin")</span>
                        </div>

                        <div class="course-meta-search">
                            <div class="meta-item-search">
                                <i class="fas fa-calendar-alt"></i>
                                <span>@course.NgayTao.ToString("dd/MM/yyyy")</span>
                            </div>
                            <div class="meta-item-search">
                                <i class="fas fa-users"></i>
                                <span>@(course.Enrollments?.Count ?? 0) học viên</span>
                            </div>
                        </div>

                        <div class="course-stats-search">
                            <div class="stat-search">
                                <div class="stat-number-search">@(course.Lessons?.Count ?? 0)</div>
                                <div class="stat-label-search">Bài học</div>
                            </div>
                            <div class="stat-search">
                                <div class="stat-number-search">@(course.Quizzes?.Count ?? 0)</div>
                                <div class="stat-label-search">Kiểm tra</div>
                            </div>
                            <div class="stat-search">
                                <div class="stat-number-search">@(course.Assignments?.Count ?? 0)</div>
                                <div class="stat-label-search">Bài tập</div>
                            </div>
                        </div>

                        <div class="course-price-search">
                            @if (course.Gia > 0)
                            {
                                <span>@course.Gia.ToString("N0")₫</span>
                            }
                            else
                            {
                                <span class="text-success">Miễn phí</span>
                            }
                        </div>

                        <div class="course-actions-search">
                            <a href="@Url.Action("Details", new { id = course.CourseID })"
                               class="btn-view-search">
                                <i class="fas fa-eye me-2"></i>Xem chi tiết
                            </a>

                            @if (User.Identity.IsAuthenticated)
                            {
                                <button class="btn-favorite-search" onclick="toggleFavorite(@course.CourseID)" title="Thêm vào yêu thích">
                                    <i class="far fa-heart"></i>
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <nav class="pagination-search">
                <ul class="pagination mb-0">
                    @if (currentPage > 1)
                    {
                        <li class="page-item">
                            @if (searchType == "name")
                            {
                                <a class="page-link" href="@Url.Action("SearchByName", new { keyword = keyword, page = currentPage - 1 })">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            }
                            else if (searchType == "topic")
                            {
                                <a class="page-link" href="@Url.Action("SearchByTopic", new { topic = topic, page = currentPage - 1 })">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            }
                            else if (searchType == "category")
                            {
                                <a class="page-link" href="@Url.Action("SearchByCategory", new { categoryId = ViewBag.CategoryId, page = currentPage - 1 })">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            }
                        </li>
                    }

                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            @if (searchType == "name")
                            {
                                <a class="page-link" href="@Url.Action("SearchByName", new { keyword = keyword, page = i })">@i</a>
                            }
                            else if (searchType == "topic")
                            {
                                <a class="page-link" href="@Url.Action("SearchByTopic", new { topic = topic, page = i })">@i</a>
                            }
                            else if (searchType == "category")
                            {
                                <a class="page-link" href="@Url.Action("SearchByCategory", new { categoryId = ViewBag.CategoryId, page = i })">@i</a>
                            }
                        </li>
                    }

                    @if (currentPage < totalPages)
                    {
                        <li class="page-item">
                            @if (searchType == "name")
                            {
                                <a class="page-link" href="@Url.Action("SearchByName", new { keyword = keyword, page = currentPage + 1 })">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            }
                            else if (searchType == "topic")
                            {
                                <a class="page-link" href="@Url.Action("SearchByTopic", new { topic = topic, page = currentPage + 1 })">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            }
                            else if (searchType == "category")
                            {
                                <a class="page-link" href="@Url.Action("SearchByCategory", new { categoryId = ViewBag.CategoryId, page = currentPage + 1 })">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            }
                        </li>
                    }
                </ul>
            </nav>
        }
    }
    else
    {
        <div class="no-results" data-aos="fade-up">
            <i class="fas fa-search"></i>
            <h3>Không tìm thấy kết quả phù hợp</h3>
            <p class="mb-4">Hãy thử tìm kiếm với từ khóa khác hoặc khám phá các khóa học phổ biến</p>
            <a href="@Url.Action("Index")" class="btn btn-primary btn-lg">
                <i class="fas fa-th-large me-2"></i>Xem tất cả khóa học
            </a>

            <!-- Search Suggestions -->
            <div class="search-suggestions">
                <h6 class="mb-3">Gợi ý tìm kiếm:</h6>
                <a href="@Url.Action("SearchByName", new { keyword = "Web Development" })" class="suggestion-item">Web Development</a>
                <a href="@Url.Action("SearchByName", new { keyword = "Programming" })" class="suggestion-item">Programming</a>
                <a href="@Url.Action("SearchByName", new { keyword = "Design" })" class="suggestion-item">Design</a>
                <a href="@Url.Action("SearchByName", new { keyword = "Marketing" })" class="suggestion-item">Marketing</a>
                <a href="@Url.Action("SearchByName", new { keyword = "Business" })" class="suggestion-item">Business</a>
                <a href="@Url.Action("SearchByName", new { keyword = "Data Science" })" class="suggestion-item">Data Science</a>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 1000,
            easing: 'ease-out-quart',
            once: true
        });

        function applySortFilter() {
            const sortValue = $('#sortFilter').val();
            const courses = $('.course-item').toArray();

            courses.sort((a, b) => {
                const $a = $(a);
                const $b = $(b);

                switch(sortValue) {
                    case 'popular':
                        return parseInt($b.data('enrollments')) - parseInt($a.data('enrollments'));
                    case 'newest':
                        return new Date($b.data('created')) - new Date($a.data('created'));
                    case 'price-low':
                        return parseFloat($a.data('price')) - parseFloat($b.data('price'));
                    case 'price-high':
                        return parseFloat($b.data('price')) - parseFloat($a.data('price'));
                    case 'relevance':
                    default:
                        return 0;
                }
            });

            const container = $('#searchResults');
            courses.forEach(course => {
                container.append(course);
            });

            // Re-trigger AOS
            AOS.refresh();
        }

        function applyPriceFilter() {
            const priceValue = $('#priceFilter').val();
            const courses = $('.course-item');

            courses.each(function() {
                const $course = $(this);
                const price = parseFloat($course.data('price'));
                let shouldShow = true;

                switch(priceValue) {
                    case 'free':
                        shouldShow = price === 0;
                        break;
                    case 'paid':
                        shouldShow = price > 0;
                        break;
                    case 'all':
                    default:
                        shouldShow = true;
                        break;
                }

                $course.toggle(shouldShow);
            });
        }

        function toggleFavorite(courseId) {
        @if (User.Identity.IsAuthenticated)
        {
            <text>
                    $.post('@Url.Action("AddToFavorite", "Course")', {
                        courseId: courseId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    })
                    .done(function(response) {
                        if (response.success) {
                            toastr.success(response.message);
                        } else {
                            toastr.error(response.message);
                        }
                    })
                    .fail(function() {
                        toastr.error('Có lỗi xảy ra!');
                    });
            </text>
        }
        else
        {
            <text>
                    window.location.href = '/Identity/Account/Login';
            </text>
        }
        }

        // Configure toastr
        if (typeof toastr !== 'undefined') {
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "timeOut": 3000
            };
        }
    </script>

    @if (User.Identity.IsAuthenticated)
    {
        @Html.AntiForgeryToken()
    }
}