@{
    ViewBag.Title = "Teacher Livestream";
    var apiBase = (string)ViewBag.ApiBase;
    var roomId = (Guid)ViewBag.RoomId;
    var participantId = (Guid)ViewBag.ParticipantId;
    var teacherPid = (Guid)ViewBag.TeacherParticipantId;
    var displayName = (string)ViewBag.DisplayName;
}

@section Styles {
    <link rel="stylesheet" href="~/css/live.css" asp-append-version="true" />
}

<h2 class="mb-2">Teacher Livestream</h2>

<div class="room-meta">
    <span class="badge" title="Room Id">🏷️ @roomId</span>
    <span class="badge" title="Participant Id">🧑‍🏫 @participantId</span>
</div>

<div id="live-config"
     data-api-base="@apiBase"
     data-room-id="@roomId"
     data-my-id="@participantId"
     data-teacher-id="@teacherPid"
     data-display-name="@displayName"></div>

<div class="live-container">
    <div class="live-grid">
        <div class="live-card">
            <div class="live-card-header">
                <div class="live-card-title">Luồng phát của bạn</div>
                <div class="live-meta">
                    <span>Trạng thái: <span class="kbd" id="live-status">READY</span></span>
                </div>
            </div>
            <div class="live-card-body">
                <div class="live-video-wrap">
                    <video id="localVideo" class="live-video" autoplay playsinline muted></video>
                </div>

                <div class="live-toolbar">
                    <button id="btnUseCamera" class="pill-btn" type="button">📷 Dùng camera</button>
                    <button id="btnShareScreen" class="pill-btn primary" type="button">🖥️ Chia sẻ màn hình</button>
                    <button id="btnUseOBS" class="pill-btn" type="button">🎥 Dùng OBS Virtual Camera</button>

                    <button id="btnCopyStudentLink" class="pill-btn copy-link" type="button" title="Sao chép link dành cho học viên" style="margin-left:auto;">
                        🔗 Copy link học viên
                    </button>
                </div>
            </div>
        </div>

        @await Html.PartialAsync("_ChatBox")
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_StompScripts")

    <!-- ICE: Xirsys Static Credentials (ưu tiên TURN qua TLS 443) -->
    <script>
        window.LIVE_TURN = [
            { urls: 'stun:stun.l.google.com:19302' }, // thêm 1 STUN phổ biến để dự phòng
            { urls: 'stun:ss-turn1.xirsys.com' },
            {
                username: 'WZjM1BJjBkkr83i7m5Sco72U3SDf7IEMYha5NOkOwwfuiVqDhR2G5Hs4tHrP5zKAAAAAAGkDwIhYb2Fud3M=',
                credential: '18f71050-b5c9-11f0-9926-0242ac140004',
                urls: [
                    'turns:ss-turn1.xirsys.com:443?transport=tcp',
                    'turns:ss-turn1.xirsys.com:5349?transport=tcp',
                    'turn:ss-turn1.xirsys.com:3478?transport=tcp',
                    'turn:ss-turn1.xirsys.com:80?transport=tcp',
                    'turn:ss-turn1.xirsys.com:3478?transport=udp',
                    'turn:ss-turn1.xirsys.com:80?transport=udp'
                ]
            }
        ];
        (function () {
            const params = new URLSearchParams(location.search);
            window.FORCE_TURN = params.get('forceTurn') === '1';
            console.log('[LIVE] FORCE_TURN(page):', window.FORCE_TURN);
        })();
    </script>

    <script>
        (function () {
            const btn = document.getElementById('btnCopyStudentLink');
            if (!btn) return;
            const roomId = '@roomId';
            btn.addEventListener('click', async () => {
                const link = `${location.origin}/Live/Student?roomId=${roomId}&userId=0&forceTurn=1`;
                try {
                    await navigator.clipboard.writeText(link);
                    const old = btn.textContent;
                    btn.textContent = '✅ Đã copy';
                    setTimeout(() => btn.textContent = '🔗 Copy link học viên', 1600);
                } catch (e) {
                    const ta = document.createElement('textarea');
                    ta.value = link;
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); } catch {}
                    document.body.removeChild(ta);
                    alert('Đã copy link:\n' + link);
                }
            });
        })();
    </script>

    <script src="~/js/live-teacher.js" asp-append-version="true"></script>
}