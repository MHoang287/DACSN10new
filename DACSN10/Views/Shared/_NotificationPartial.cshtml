@* Notification Bell Dropdown Component *@
<div class="notification-container">
    <div class="dropdown">
        <button class="btn btn-link notification-bell" type="button" id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
        </button>
        
        <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown">
            <div class="notification-header">
                <h6>Thông báo</h6>
                <button class="btn btn-sm btn-link mark-all-read" id="markAllReadBtn" title="Đánh dấu tất cả đã đọc">
                    <i class="fas fa-check-double"></i>
                </button>
            </div>
            
            <div class="notification-list" id="notificationList">
                <div class="text-center py-4">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.notification-container {
    position: relative;
}

.notification-bell {
    position: relative;
    padding: 8px 12px;
    font-size: 20px;
    color: #6c757d;
    text-decoration: none;
    transition: color 0.3s;
}

.notification-bell:hover {
    color: #007bff;
}

.notification-badge {
    position: absolute;
    top: 0;
    right: 0;
    background: #dc3545;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: bold;
    min-width: 18px;
    text-align: center;
}

.notification-dropdown {
    width: 420px;
    max-height: 550px;
    border: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border-radius: 10px;
    overflow: hidden;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    background: #f8f9fa;
}

.notification-header h6 {
    margin: 0;
    font-weight: 600;
    color: #333;
}

.mark-all-read {
    padding: 4px 8px;
    color: #6c757d;
    text-decoration: none;
    font-size: 14px;
}

.mark-all-read:hover {
    color: #007bff;
}

.notification-list {
    max-height: 420px;
    overflow-y: auto;
    background: #fff;
}

.notification-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.notification-item:hover {
    background: #f8f9fa;
}

.notification-item.unread {
    background: linear-gradient(to right, #e7f3ff 0%, #fff 100%);
}

.notification-item.unread::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    background: #007bff;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.notification-item.unread .notification-content {
    margin-left: 15px;
}

.notification-wrapper {
    display: flex;
    align-items: start;
    gap: 12px;
}

.notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}

.notification-icon.new-lesson {
    background: #e3f2fd;
    color: #1976d2;
}

.notification-icon.new-quiz {
    background: #fff3e0;
    color: #f57c00;
}

.notification-icon.new-course {
    background: #e8f5e9;
    color: #388e3c;
}

.notification-icon.live-stream {
    background: #fce4ec;
    color: #c2185b;
}

.notification-icon.enrollment {
    background: #f3e5f5;
    color: #7b1fa2;
}

.notification-content {
    flex: 1;
    min-width: 0;
}

.notification-title {
    font-weight: 600;
    font-size: 14px;
    color: #333;
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.notification-message {
    font-size: 13px;
    color: #666;
    margin-bottom: 6px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.notification-time {
    font-size: 11px;
    color: #999;
}

.notification-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.notification-action {
    padding: 4px 8px;
    font-size: 11px;
    border-radius: 4px;
    border: 1px solid;
    background: transparent;
    cursor: pointer;
    transition: all 0.2s;
}

.notification-action.mark-read {
    border-color: #28a745;
    color: #28a745;
}

.notification-action.mark-read:hover {
    background: #28a745;
    color: white;
}

.notification-action.delete {
    border-color: #dc3545;
    color: #dc3545;
}

.notification-action.delete:hover {
    background: #dc3545;
    color: white;
}

.notification-footer {
    padding: 10px;
    text-align: center;
    border-top: 1px solid #eee;
    background: #f8f9fa;
}

.notification-footer a {
    color: #007bff;
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
}

.notification-empty {
    padding: 40px 20px;
    text-align: center;
    color: #999;
}

.notification-empty i {
    font-size: 48px;
    color: #ddd;
    margin-bottom: 15px;
}

/* Scrollbar styling */
.notification-list::-webkit-scrollbar {
    width: 6px;
}

.notification-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.notification-list::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

.notification-list::-webkit-scrollbar-thumb:hover {
    background: #999;
}

/* Toast notification for success messages */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: none;
    z-index: 10000;
    animation: slideInRight 0.3s ease-out;
}
</style>

<div class="toast-notification" id="toastNotification"></div>

<script>
    const NOTIF_API = "/Api/Notifications";

    document.addEventListener('DOMContentLoaded', () => {
        loadUnreadCount();

        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown) dropdown.addEventListener('click', () => loadNotifications());

        const markAllBtn = document.getElementById('markAllReadBtn');
        if (markAllBtn) {
            markAllBtn.addEventListener('click', e => {
                e.preventDefault();
                e.stopPropagation();
                markAllAsRead();
            });
        }

        setInterval(loadUnreadCount, 30000); // refresh badge mỗi 30s
    });

    // ================= UNREAD BADGE =================

    function loadUnreadCount() {
        fetch(`${NOTIF_API}/GetUnread`)
            .then(r => r.json())
            .then(res => {
                if (res && res.success) updateBadge(res.count || 0);
            })
            .catch(err => console.error("Unread error:", err));
    }

    function updateBadge(count) {
        const badge = document.getElementById("notificationBadge");
        if (!badge) return;

        if (count > 0) {
            badge.textContent = count > 99 ? "99+" : count;
            badge.style.display = "inline-block";
        } else {
            badge.style.display = "none";
        }
    }

    // ================= LOAD NOTIFICATIONS =================

    function loadNotifications() {
        const list = document.getElementById("notificationList");
        if (!list) return;

        list.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary"></div>
            </div>
        `;

        fetch(`${NOTIF_API}/GetNotifications?pageSize=10&pageNumber=1`)
            .then(r => r.json())
            .then(res => {
                const arr = Array.isArray(res.data) ? res.data : [];
                displayNotifications(arr);
            })
            .catch(err => {
                console.error("Error load notifications:", err);
                list.innerHTML = `<div class="notification-empty"><i class="fas fa-exclamation-triangle"></i><p>Lỗi khi tải thông báo</p></div>`;
            });
    }

    // ================= DISPLAY LIST =================

    function displayNotifications(notifications) {
        const list = document.getElementById("notificationList");
        if (!list) return;

        if (!Array.isArray(notifications) || notifications.length === 0) {
            list.innerHTML = `
                <div class="notification-empty">
                    <i class="fas fa-bell"></i>
                    <p>Bạn chưa có thông báo nào</p>
                </div>`;
            return;
        }

        let html = "";

        notifications.forEach(n => {
            // hỗ trợ cả PascalCase và camelCase
            const id      = n.notificationID ?? n.NotificationID;
            const type    = n.type ?? n.Type;
            const link    = n.link ?? n.Link ?? "";
            const title   = n.title ?? n.Title ?? "";
            const message = n.message ?? n.Message ?? "";
            const timeAgo = n.timeAgo ?? n.TimeAgo ?? "";
            const isRead  = n.isRead ?? n.IsRead;

            html += `
                <div class="notification-item ${isRead ? "" : "unread"}"
                     data-id="${id}"
                     data-link="${link}">

                    <div class="notification-wrapper">

                        <div class="notification-icon ${getNotificationIconClass(type)}">
                            ${getNotificationIcon(type)}
                        </div>

                        <div class="notification-content">
                            <div class="notification-title">${title}</div>
                            <div class="notification-message">${message}</div>
                            <div class="notification-time"><i class="far fa-clock"></i> ${timeAgo}</div>

                            <div class="notification-actions">
                                ${!isRead ? `
                                <button class="notification-action mark-read"
                                        onclick="markAsRead(event, ${id})">
                                    <i class="fas fa-check"></i> Đánh dấu đã xem
                                </button>` : ""}

                                <button class="notification-action delete"
                                        onclick="deleteNotification(event, ${id})">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            `;
        });

        list.innerHTML = html;

        // click item để mở link
        document.querySelectorAll(".notification-item").forEach(item => {
            item.addEventListener("click", e => {
                if (e.target.closest(".notification-actions")) return;

                const id = parseInt(item.dataset.id);
                const link = item.dataset.link;

                if (link) {
                    fetch(`${NOTIF_API}/MarkAsRead`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(id)
                    }).finally(() => window.location.href = link);
                }
            });
        });
    }

    // ================= ICONS =================

    function getNotificationIconClass(type) {
        const classes = {
            "NewLesson": "new-lesson",
            "NewQuiz": "new-quiz",
            "NewCourse": "new-course",
            "LiveStream": "live-stream",
            "EnrollmentSuccess": "enrollment"
        };
        return classes[type] || "new-lesson";
    }

    function getNotificationIcon(type) {
        const icons = {
            "NewLesson": '<i class="fas fa-book-open"></i>',
            "NewQuiz": '<i class="fas fa-clipboard-question"></i>',
            "NewCourse": '<i class="fas fa-graduation-cap"></i>',
            "LiveStream": '<i class="fas fa-video"></i>',
            "EnrollmentSuccess": '<i class="fas fa-check-circle"></i>'
        };
        return icons[type] || '<i class="fas fa-bell"></i>';
    }

    // ================= ACTIONS =================

    function markAsRead(e, id) {
        e.stopPropagation();

        fetch(`${NOTIF_API}/MarkAsRead`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(id)
        })
        .then(r => r.json())
        .then(res => {
            if (res && res.success) {
                showToast("Đã đánh dấu là đã xem");
                loadUnreadCount();
                loadNotifications();
            }
        });
    }

    function deleteNotification(e, id) {
        e.stopPropagation();

        if (!confirm("Bạn có chắc muốn xóa thông báo này?")) return;

        fetch(`${NOTIF_API}/Delete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(id)
        })
        .then(r => r.json())
        .then(res => {
            if (res && res.success) {
                showToast("Đã xóa thông báo");
                loadUnreadCount();
                loadNotifications();
            }
        });
    }

    function markAllAsRead() {
        fetch(`${NOTIF_API}/MarkAllAsRead`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
        })
        .then(r => r.json())
        .then(res => {
            if (res && res.success) {
                showToast("Đã đánh dấu tất cả");
                loadUnreadCount();
                loadNotifications();
            }
        });
    }

    // ================= TOAST =================

    function showToast(msg) {
        const div = document.getElementById("toastNotification");
        if (!div) return;

        div.textContent = msg;
        div.style.display = "block";

        setTimeout(() => div.style.display = "none", 2500);
    }
</script>


